<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhasmShop Admin | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #f1f5f9; }
        .admin-card { background: #fff1f2; border: 2px solid #fda4af; border-radius: 20px; padding: 15px; margin-bottom: 20px; }
        .order-item { background: white; border-right: 4px solid #3b82f6; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .rank-badge { font-size: 10px; padding: 2px 8px; border-radius: 20px; font-weight: bold; }
        .bronze { background: #cd7f32; color: #fff; }
        .silver { background: #c0c0c0; color: #000; }
        .gold { background: #ffd700; color: #000; }
        .platinum { background: #e5e4e2; color: #000; }
        .diamond { background: #b9f2ff; color: #000; }
    </style>
</head>
<body>

<div id="intro-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="text-white text-4xl font-black mb-8 italic">KHASM<span class="text-blue-500">SHOP</span></div>
    <button onclick="login()" class="bg-white text-black px-8 py-4 rounded-2xl font-black flex items-center gap-3">
        <img src="https://www.google.com/favicon.ico" class="w-5"> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ¬Ø±
    </button>
</div>

<div id="app" class="hidden pb-24">
    <header class="p-4 flex justify-between items-center bg-white border-b sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <img id="uImg" class="w-12 h-12 rounded-full border-2 border-yellow-500" src="">
            <div>
                <p id="uName" class="font-black text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..</p>
                <div id="uRank" class="rank-badge bronze">Ø¨Ø±ÙˆÙ†Ø²ÙŠ</div>
            </div>
        </div>
        <div class="text-left">
            <p id="uBal" class="font-black text-lg text-green-600">0 Ø¬.Ø³</p>
            <p id="uID" class="text-[10px] text-gray-400 font-bold italic"></p>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <div id="adminArea" class="hidden">
            <h2 class="font-black text-red-600 mb-4 flex items-center gap-2"><i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</h2>
            
            <div class="admin-card">
                <p class="font-bold text-xs mb-2">Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„Ù…Ø³ØªØ®Ø¯Ù…:</p>
                <div class="flex gap-2">
                    <input id="targetWallet" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©" class="flex-1 p-2 rounded-lg text-xs border">
                    <input id="amountToAdd" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="w-20 p-2 rounded-lg text-xs border">
                    <button onclick="adminAddBalance()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold">Ø´Ø­Ù†</button>
                </div>
            </div>

            <h3 class="font-black text-sm mb-3">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ğŸ“¥</h3>
            <div id="adminOrdersList" class="space-y-3 mb-8">
                <p class="text-xs text-gray-500 italic">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹..</p>
            </div>
            <hr class="mb-8 border-gray-300">
        </div>

        <h3 class="font-black text-slate-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ© ğŸ’</h3>
        <div id="productGrid" class="grid grid-cols-2 gap-3">
            </div>
    </main>
</div>

<button onclick="toggleSupport()" class="fixed bottom-6 right-6 bg-green-500 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl z-50">
    <i class="fab fa-whatsapp"></i>
</button>

<div id="orderModal" class="fixed inset-0 z-[6000] bg-black/60 backdrop-blur-sm flex items-end justify-center hidden">
    <div class="w-full max-w-md bg-white rounded-t-[40px] p-8">
        <h3 class="font-black text-xl text-center mb-2" id="mTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
        <p id="mPrice" class="text-center text-green-600 font-bold mb-6"></p>
        <input id="gID" type="number" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="w-full bg-gray-50 p-4 rounded-2xl mb-4 font-bold border text-center outline-none">
        <input id="gName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©" class="w-full bg-gray-50 p-4 rounded-2xl mb-4 font-bold border text-center outline-none">
        <button onclick="confirmOrder()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button>
        <button onclick="closeModal()" class="w-full py-2 text-gray-400 text-xs mt-2">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", 
        authDomain: "khasmshop.firebaseapp.com", 
        projectId: "khasmshop", 
        storageBucket: "khasmshop.firebasestorage.app", 
        messagingSenderId: "238182001615", 
        appId: "1:238182001615:web:d77391030a40a481b440ba" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const ADMIN_EMAIL = "mhmdfthu98@gmail.com";
    let userData = null;
    let selectedItem = null;

    const products = [
        { name: "60 US", price: 4000, uc: 60 },
        { name: "325 US", price: 20000, uc: 325 },
        { name: "660 US", price: 44000, uc: 660 },
        { name: "1800 US", price: 95000, uc: 1800 },
        { name: "3850 US", price: 190000, uc: 3850 },
        { name: "8100 US", price: 380000, uc: 8100 },
        { name: "Ø¨Ø±Ø§ÙŠÙ… Ø´Ù‡Ø±", price: 4500, uc: 0 },
        { name: "Ø¨Ø±Ø§ÙŠÙ… Ø¨Ù„Øµ", price: 45000, uc: 0 },
        { name: "Ø­Ø²Ù…Ø© Ø§Ù„Ù…ØªØ±ÙŠÙ„Ø§Øª", price: 13500, uc: 0 }
    ];

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('intro-screen').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('intro-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }, 500);

            if(user.email === ADMIN_EMAIL) {
                document.getElementById('adminArea').classList.remove('hidden');
                loadAdminOrders();
            }
            syncUser(user);
        }
    });

    async function syncUser(user) {
        const userRef = doc(db, "users", user.uid);
        onSnapshot(userRef, (snap) => {
            if (snap.exists()) {
                userData = snap.data();
                renderUI();
            } else {
                const wid = Math.floor(100000 + Math.random() * 900000).toString();
                setDoc(userRef, {
                    name: user.displayName,
                    email: user.email,
                    img: user.photoURL,
                    walletID: wid,
                    balance: 0,
                    totalUC: 0
                });
            }
        });
    }

    function renderUI() {
        document.getElementById('uName').innerText = userData.name;
        document.getElementById('uImg').src = userData.img;
        document.getElementById('uBal').innerText = userData.balance.toLocaleString() + " Ø¬.Ø³";
        document.getElementById('uID').innerText = `Ù…Ø­ÙØ¸Ø©: #${userData.walletID}`;

        let rank = "Ø¨Ø±ÙˆÙ†Ø²ÙŠ", discount = 0, cls = "bronze";
        if(userData.totalUC >= 3000) { rank="Ù…Ø§Ø³ÙŠ"; discount=0.12; cls="diamond"; }
        else if(userData.totalUC >= 2000) { rank="Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ"; discount=0.09; cls="platinum"; }
        else if(userData.totalUC >= 1500) { rank="Ø°Ù‡Ø¨ÙŠ"; discount=0.06; cls="gold"; }
        else if(userData.totalUC >= 900) { rank="ÙØ¶ÙŠ"; discount=0.03; cls="silver"; }

        const rBadge = document.getElementById('uRank');
        rBadge.innerText = rank;
        rBadge.className = `rank-badge ${cls}`;

        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';
        products.forEach(p => {
            const finalPrice = p.price - (p.price * discount);
            grid.innerHTML += `
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm text-center">
                    <p class="font-black text-xs mb-1">${p.name}</p>
                    <p class="text-blue-600 font-bold text-sm">${finalPrice.toLocaleString()} Ø¬.Ø³</p>
                    <button onclick="openOrder('${p.name}', ${finalPrice}, ${p.uc})" class="w-full mt-3 bg-slate-900 text-white text-[10px] py-2 rounded-xl font-bold">Ø·Ù„Ø¨ Ø´Ø­Ù†</button>
                </div>
            `;
        });
    }

    window.login = () => signInWithPopup(auth, provider);
    window.openOrder = (name, price, uc) => {
        selectedItem = { name, price, uc };
        document.getElementById('mTitle').innerText = name;
        document.getElementById('mPrice').innerText = `Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${price.toLocaleString()} Ø¬.Ø³`;
        document.getElementById('orderModal').classList.remove('hidden');
    };
    window.closeModal = () => document.getElementById('orderModal').classList.add('hidden');

    window.confirmOrder = async () => {
        if(userData.balance < selectedItem.price) return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ø´Ø­Ù† Ù…Ø­ÙØ¸ØªÙƒ.");
        const gid = document.getElementById('gID').value;
        const gname = document.getElementById('gName').value;
        if(!gid || !gname) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            balance: increment(-selectedItem.price),
            totalUC: increment(selectedItem.uc)
        });

        await addDoc(collection(db, "orders"), {
            uName: userData.name,
            wallet: userData.walletID,
            product: selectedItem.name,
            gameID: gid,
            gameName: gname,
            status: 'pending',
            timestamp: new Date()
        });

        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
        closeModal();
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯ÙŠØ±
    window.adminAddBalance = async () => {
        const wid = document.getElementById('targetWallet').value;
        const amount = parseInt(document.getElementById('amountToAdd').value);
        const q = query(collection(db, "users"), where("walletID", "==", wid));
        const snap = await getDocs(q);
        if(snap.empty) return alert("Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        snap.forEach(d => updateDoc(doc(db, "users", d.id), { balance: increment(amount) }));
        alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­!");
    };

    function loadAdminOrders() {
        onSnapshot(collection(db, "orders"), (snap) => {
            const list = document.getElementById('adminOrdersList');
            list.innerHTML = '';
            snap.forEach(d => {
                const o = d.data();
                list.innerHTML += `
                    <div class="order-item">
                        <div class="flex justify-between items-start">
                            <p class="text-[11px] font-black">${o.product} ğŸ®</p>
                            <button onclick="deleteOrder('${d.id}')" class="bg-green-100 text-green-600 px-3 py-1 rounded-lg text-[10px] font-bold">ØªÙ… Ø§Ù„Ø´Ø­Ù† âœ…</button>
                        </div>
                        <p class="text-[10px] mt-1 text-blue-600 font-bold">ID: ${o.gameID} | Ø§Ù„Ø§Ø³Ù…: ${o.gameName}</p>
                        <p class="text-[9px] text-gray-400">Ø§Ù„Ø²Ø¨ÙˆÙ†: ${o.uName} (#${o.wallet})</p>
                    </div>
                `;
            });
        });
    }

    window.deleteOrder = async (id) => {
        if(confirm("Ù‡Ù„ ØªØ£ÙƒØ¯Øª Ù…Ù† Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.")) {
            await deleteDoc(doc(db, "orders", id));
        }
    };

    window.toggleSupport = () => {
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø®ØµÙ… Ø´ÙˆØ¨ØŒ Ø£Ø±ÙŠØ¯ Ø´Ø­Ù† Ù…Ø­ÙØ¸ØªÙŠ. Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ÙŠ: ${userData?.walletID}`;
        window.open(`https://wa.me/249907760989?text=${encodeURIComponent(msg)}`);
    };

</script>
</body>
  </html>

