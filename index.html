<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhasmShop | Ø§Ù„Ù…Ù„Ø­Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #f4f7fe; }
        .pubg-banner { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://w0.peakpx.com/wallpaper/403/602/HD-wallpaper-pubg-mobile-karakin-pubg-mobile-poster-battle-royale-2021-games-pubg.jpg'); background-size: cover; height: 150px; border-radius: 0 0 35px 35px; }
        .category-title { border-right: 4px solid #f59e0b; padding-right: 10px; margin: 25px 0 15px 0; font-weight: 900; color: #1e293b; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
    </style>
</head>
<body>

<div id="app" class="pb-24">
    <div class="pubg-banner flex flex-col items-center justify-center text-white p-4">
        <h1 class="text-2xl font-black italic">Ù…ØªØ¬Ø± Ø§Ù„Ø®ØµÙ… ğŸ’¥</h1>
        <p class="text-[10px] opacity-70">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø±ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…ØªÙˆÙØ±Ø© Ø§Ù„Ø¢Ù†</p>
    </div>

    <main class="max-w-md mx-auto -mt-10 px-4">
        <div class="bg-white rounded-[32px] p-5 shadow-xl mb-6 border border-white">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <img id="uImg" class="w-12 h-12 rounded-2xl border-2 border-slate-100" src="">
                    <div>
                        <h2 id="uName" class="font-black text-sm text-slate-800">--</h2>
                        <p id="uWallet" class="text-[9px] font-bold text-blue-500 mt-0.5 italic"></p>
                    </div>
                </div>
                <button onclick="logout()" class="text-slate-400 p-2"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-900 p-4 rounded-3xl text-white text-center">
                    <p class="text-[8px] text-slate-400 mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</p>
                    <p class="font-black text-lg text-yellow-500"><span id="uBal">0</span> <small class="text-[8px]">Ø¬.Ø³</small></p>
                </div>
                <div class="bg-slate-900 p-4 rounded-3xl text-white text-center">
                    <p class="text-[8px] text-slate-400 mb-1">Ù†Ù‚Ø§Ø·Ùƒ â­</p>
                    <p id="uPoints" class="font-black text-lg text-blue-400">0</p>
                </div>
            </div>
            <button onclick="redeemPoints()" class="w-full py-3 bg-amber-500 text-white rounded-2xl font-black text-xs shadow-lg shadow-amber-200">
                Ø¥Ø³ØªØ¨Ø¯Ø§Ù„ 30 Ù†Ù‚Ø·Ø© Ø¨Ù€ 60 UC Ù…Ø¬Ø§Ù†Ø§Ù‹ ğŸ
            </button>
        </div>

        <div id="adminArea" class="hidden bg-white rounded-3xl p-5 shadow-md border-t-4 border-red-500 mb-8">
            <h3 class="font-black text-xs mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„ÙˆÙƒÙ„Ø§Ø¡ ğŸ› ï¸</h3>
            <div id="adminOrdersList" class="space-y-4"></div>
        </div>

        <h3 class="category-title">Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø®ØµÙ… 5Ùª) âš¡</h3>
        <div id="directGrid" class="grid grid-cols-2 gap-3"></div>

        <h3 class="category-title">Ø§Ù„Ø´Ø­Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ¯ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹) ğŸ’¥</h3>
        <div id="idGrid" class="grid grid-cols-2 gap-3"></div>

        <h3 class="category-title">Ø­Ø²Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ğŸ’</h3>
        <div id="subsGrid" class="grid grid-cols-1 gap-3"></div>

        <h3 class="category-title">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒ ğŸ“¦</h3>
        <div id="userOrdersList" class="space-y-3"></div>
    </main>
</div>

<div id="confirmModal" class="modal">
    <div class="bg-white w-full max-w-sm rounded-[35px] p-6 text-right">
        <h3 class="font-black text-lg mb-4 text-slate-800 border-b pb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸ§¾</h3>
        <div class="space-y-3 text-sm mb-6" id="confirmDetails">
            </div>
        <div class="flex gap-2">
            <button onclick="finalizeOrderRequest()" class="flex-1 bg-green-600 text-white py-3 rounded-2xl font-black">ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ âœ…</button>
            <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-2xl font-black">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, query, where, getDocs, updateDoc, increment, deleteDoc, setDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", 
        authDomain: "khasmshop.firebaseapp.com", 
        projectId: "khasmshop", 
        storageBucket: "khasmshop.firebasestorage.app", 
        messagingSenderId: "238182001615", 
        appId: "1:238182001615:web:d77391030a40a481b440ba" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const ADMINS = ["mhmdfthu98@gmail.com", "muhammedaltaj111@gmail.com", "mohnadyasir43@gmail.com"];
    let userData = null;
    let tempOrder = null;

    const products = {
        direct: [
            { id: 'd1', name: "60 UC", price: 4000, uc: 60 },
            { id: 'd2', name: "325 UC", price: 20000, uc: 325 },
            { id: 'd3', name: "660 UC", price: 40000, uc: 660 },
            { id: 'd4', name: "1800 UC", price: 100000, uc: 1800 },
            { id: 'd5', name: "3850 UC", price: 200000, uc: 3850 },
            { id: 'd6', name: "8100 UC", price: 400000, uc: 8100 }
        ],
        id: [
            { id: 'i1', name: "385 UC", price: 26000, uc: 385 },
            { id: 'i2', name: "720 UC", price: 40000, uc: 720 },
            { id: 'i3', name: "60 UC", price: 4000, uc: 60 },
            { id: 'i4', name: "325 UC", price: 20000, uc: 325 },
            { id: 'i5', name: "660 UC", price: 44000, uc: 660 },
            { id: 'i6', name: "1800 UC", price: 95000, uc: 1800 },
            { id: 'i7', name: "3850 UC", price: 190000, uc: 3850 },
            { id: 'i8', name: "8100 UC", price: 380000, uc: 8100 }
        ],
        subs: [
            { id: 's1', name: "Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø±Ø§ÙŠÙ… Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯ ğŸ’¥", price: 4500, uc: 0 },
            { id: 's2', name: "Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø±Ø§ÙŠÙ… Ø¨Ù„Øµ Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯ ğŸ’¥", price: 45000, uc: 0 },
            { id: 's3', name: "Ø­Ø²Ù…Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„Ù‰ ğŸ’«", price: 10000, uc: 0 },
            { id: 's4', name: "Ø­Ø²Ù…Ø© Ø§Ù„ÙƒØ±Ø³ØªØ§Ù„Ø§Øª ğŸ’«", price: 16000, uc: 0 },
            { id: 's5', name: "Ø­Ø²Ù…Ø© Ø§Ù„Ù…ØªØ±ÙŠØ§Ù„Ø§Øª ğŸ’«", price: 13500, uc: 0 },
            { id: 's6', name: "Ø­Ø²Ù…Ø© ÙƒØ±Ø³ØªØ§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ğŸ’", price: 10000, uc: 0 }
        ]
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                    renderUI();
                    if(ADMINS.includes(user.email)) loadAdminOrders();
                    loadUserOrders(user.uid);
                } else {
                    setDoc(doc(db, "users", user.uid), {
                        name: user.displayName, email: user.email, img: user.photoURL,
                        walletID: Math.floor(100000 + Math.random() * 900000).toString(),
                        balance: 0, points: 0
                    });
                }
            });
        }
    });

    function renderUI() {
        document.getElementById('uName').innerText = userData.name;
        document.getElementById('uImg').src = userData.img;
        document.getElementById('uBal').innerText = userData.balance.toLocaleString();
        document.getElementById('uPoints').innerText = userData.points || 0;
        document.getElementById('uWallet').innerText = `ID: #${userData.walletID}`;

        const r = (id, list) => {
            const g = document.getElementById(id);
            g.innerHTML = '';
            list.forEach(p => {
                g.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-50 text-center">
                        <p class="font-black text-[11px] text-slate-700">${p.name}</p>
                        <p class="text-blue-600 font-bold text-xs my-2">${p.price.toLocaleString()} Ø¬</p>
                        <button onclick="initOrder('${p.name}', ${p.price}, ${p.uc})" class="w-full bg-slate-900 text-white text-[9px] py-2.5 rounded-2xl font-bold">Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
                    </div>`;
            });
        };
        r('directGrid', products.direct); r('idGrid', products.id); r('subsGrid', products.subs);
    }

    window.initOrder = (name, price, uc) => {
        if(userData.balance < price) return alert("âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");
        const gID = prompt("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨:");
        const gName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©:");
        if(!gID || !gName) return;

        tempOrder = { name, price, uc, gID, gName };
        document.getElementById('confirmDetails').innerHTML = `
            <p>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: <b>${name}</b></p>
            <p>ğŸ’° Ø§Ù„Ø³Ø¹Ø±: <b>${price.toLocaleString()} Ø¬.Ø³</b></p>
            <p>ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: <b>${gID}</b></p>
            <p>ğŸ® Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨: <b>${gName}</b></p>
            <p class="text-blue-500 font-bold">â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙŠ Ø³ØªÙƒØ³Ø¨Ù‡Ø§: ${Math.floor((uc/60)*2)}</p>
        `;
        document.getElementById('confirmModal').classList.add('active');
    };

    window.finalizeOrderRequest = async () => {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-tempOrder.price) });
        await addDoc(collection(db, "orders"), {
            uID: auth.currentUser.uid, uName: userData.name,
            product: tempOrder.name, price: tempOrder.price, uc: tempOrder.uc,
            gameID: tempOrder.gID, gameName: tempOrder.gName,
            status: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', timestamp: serverTimestamp()
        });
        closeModal();
        alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
    };

    window.closeModal = () => document.getElementById('confirmModal').classList.remove('active');

    function loadUserOrders(uid) {
        const q = query(collection(db, "orders"), where("uID", "==", uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('userOrdersList');
            list.innerHTML = '';
            snap.forEach(d => {
                const o = d.data();
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center text-[10px]">
                        <div><b>${o.product}</b><br><span class="text-slate-400">ID: ${o.gameID}</span></div>
                        <span class="font-black ${o.status==='Ù…ÙƒØªÙ…Ù„'?'text-green-600':'text-amber-500'}">${o.status}</span>
                    </div>`;
            });
        });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
    function loadAdminOrders() {
        document.getElementById('adminArea').classList.remove('hidden');
        onSnapshot(query(collection(db, "orders"), where("status", "==", "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")), (snap) => {
            const list = document.getElementById('adminOrdersList');
            list.innerHTML = '';
            snap.forEach(d => {
                const o = d.data();
                list.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-2xl text-[10px] border">
                        <div class="flex justify-between mb-2"><b>${o.product}</b> <span>${o.uName}</span></div>
                        <p>ID: ${o.gameID} | Name: ${o.gameName}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="completeOrder('${d.id}', '${o.uID}', ${o.uc})" class="flex-1 bg-green-600 text-white py-1.5 rounded-xl font-bold">Ù…ÙƒØªÙ…Ù„ âœ…</button>
                            <button onclick="failOrder('${d.id}', '${o.uID}', ${o.price})" class="flex-1 bg-red-600 text-white py-1.5 rounded-xl font-bold">ÙØ´Ù„ âŒ</button>
                        </div>
                    </div>`;
            });
        });
    }

    window.completeOrder = async (oid, uid, uc) => {
        const pts = Math.floor((uc/60)*2);
        await updateDoc(doc(db, "users", uid), { points: increment(pts) });
        await updateDoc(doc(db, "orders", oid), { status: 'Ù…ÙƒØªÙ…Ù„' });
    };

    window.failOrder = async (oid, uid, price) => {
        await updateDoc(doc(db, "users", uid), { balance: increment(price) });
        await updateDoc(doc(db, "orders", oid), { status: 'ÙØ´Ù„' });
    };

    window.redeemPoints = async () => {
        if(userData.points < 30) return alert("âŒ ØªØ­ØªØ§Ø¬ 30 Ù†Ù‚Ø·Ø©");
        const gID = prompt("Ø£Ø¯Ø®Ù„ ID Ù„Ù„Ù‡Ø¯ÙŠØ©:");
        if(!gID) return;
        await updateDoc(doc(db, "users", auth.currentUser.uid), { points: increment(-30) });
        await addDoc(collection(db, "orders"), {
            uID: auth.currentUser.uid, uName: userData.name, product: "Ù‡Ø¯ÙŠØ© 60 UC",
            gameID: gID, gameName: "Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù†Ù‚Ø§Ø·", status: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', timestamp: serverTimestamp()
        });
        alert("ğŸ ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
    };

    window.logout = () => signOut(auth).then(() => location.reload());
    window.login = () => signInWithPopup(auth, provider);

</script>
</body>
</html>
