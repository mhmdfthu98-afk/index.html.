<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KHASM SHOP | ุงููุณุฎุฉ ุงูููููุฉ</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body{font-family:'Cairo',sans-serif}
.hidden{display:none}
.glow{box-shadow:0 0 25px rgba(34,197,94,.6)}
</style>
</head>
<body class="bg-slate-100">

<!-- INTRO -->
<div id="intro" class="fixed inset-0 bg-black z-[9999] flex flex-col items-center justify-center text-white">
  <h1 class="text-4xl font-black mb-8">KHASM <span class="text-green-400">SHOP</span></h1>
  <button onclick="login()" class="bg-white text-black px-10 py-4 rounded-2xl font-black">
    ุงูุฏุฎูู ุนุจุฑ Google
  </button>
</div>

<!-- APP -->
<div id="app" class="hidden max-w-md mx-auto pb-32">

<!-- HEADER -->
<header class="flex justify-between items-center p-4 bg-white sticky top-0 z-50 shadow">
  <div class="flex items-center gap-3">
    <img id="uImg" class="w-12 h-12 rounded-xl border">
    <div>
      <p id="uName" class="font-black text-sm">...</p>
      <p id="uWallet" class="text-xs text-green-600">#---</p>
      <p id="uLevel" class="text-[10px]">ุจุฑููุฒู</p>
    </div>
  </div>
  <div class="text-left">
    <p class="text-xs">ุงูุฑุตูุฏ</p>
    <p id="uBalance" class="font-black text-green-600">0 ุฌ.ุณ</p>
  </div>
</header>

<!-- PRODUCTS -->
<main class="p-4 space-y-6">
  <h2 class="font-black text-lg">๐ฅ ุดุฏุงุช ุจุจุฌู</h2>
  <div id="products" class="grid grid-cols-2 gap-4"></div>
</main>

</div>

<!-- ORDER MODAL -->
<div id="orderModal" class="hidden fixed inset-0 z-[9000] bg-black/60 flex items-end">
  <div class="bg-white w-full p-6 rounded-t-3xl">
    <h3 id="orderTitle" class="font-black mb-4 text-center"></h3>
    <input id="gameID" class="w-full p-3 border rounded mb-3 text-center" placeholder="ID ุงููุงุนุจ">
    <input id="gameName" class="w-full p-3 border rounded mb-3 text-center" placeholder="ุงุณู ุฏุงุฎู ุงููุนุจุฉ">
    <button onclick="confirmOrder()" class="w-full bg-black text-white p-4 rounded-xl font-black">
      ุชุฃููุฏ ุงูุทูุจ ๐
    </button>
    <button onclick="closeOrder()" class="w-full text-center text-sm mt-2">ุฅูุบุงุก</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden max-w-md mx-auto bg-white mt-10 p-4 rounded-xl shadow">
  <h2 class="font-black text-center mb-4">๐ ููุญุฉ ุชุญูู ุงููุฏูุฑ</h2>

  <input id="chargeWallet" class="w-full p-3 border mb-2 rounded" placeholder="ุฑูู ุงููุญูุธุฉ">
  <input id="chargeAmount" class="w-full p-3 border mb-2 rounded" placeholder="ุงููุจูุบ">
  <input id="chargeUC" class="w-full p-3 border mb-2 rounded" placeholder="ุนุฏุฏ UC">

  <button onclick="chargeUser()" class="w-full bg-green-600 text-white p-4 rounded font-black">
    ุดุญู ุงููุญูุธุฉ
  </button>

  <hr class="my-4">

  <h3 class="font-black mb-2">๐ฆ ุงูุทูุจุงุช</h3>
  <div id="orders"></div>
</div>

<!-- WhatsApp Button -->
<button onclick="openWABox()"
class="fixed bottom-5 left-5 z-50 bg-green-500 w-16 h-16 rounded-full flex items-center justify-center glow">
  <i class="fab fa-whatsapp text-white text-3xl"></i>
</button>

<!-- WhatsApp Box -->
<div id="waBox" class="hidden fixed inset-0 z-[10000] bg-black/60 flex items-end">
  <div class="bg-white w-full rounded-t-3xl p-6">
    <h3 class="font-black text-center mb-4">ุงุฎุชุฑ ุงูุฎุฏูุฉ</h3>

    <button onclick="openAgents('support')" class="w-full bg-slate-900 text-white p-4 rounded-xl font-black mb-3">
      ๐ฌ ุงูุฏุนู ุงูููู
    </button>

    <button onclick="openAgents('charge')" class="w-full bg-green-600 text-white p-4 rounded-xl font-black">
      ๐ฐ ุดุญู ูุญูุธุฉ
    </button>

    <button onclick="closeWABox()" class="w-full mt-3 text-sm text-gray-400">ุฅูุบุงุก</button>
  </div>
</div>

<!-- Agents -->
<div id="agentsBox" class="hidden fixed inset-0 z-[10001] bg-black/60 flex items-end">
  <div class="bg-white w-full rounded-t-3xl p-6">
    <h3 class="font-black text-center mb-4">ุงุฎุชุฑ ุงููููู</h3>

    <button onclick="goWA('201550165993')" class="w-full bg-gray-100 p-4 rounded-xl mb-2">
      ๐ช๐ฌ ูุญูุฏ ูุชุญู โ ูุตุฑ
    </button>
    <button onclick="goWA('249914178935')" class="w-full bg-gray-100 p-4 rounded-xl mb-2">
      ๐ธ๐ฉ ูุญูุฏ ุงูุชุงุฌ โ ุงูุณูุฏุงู
    </button>
    <button onclick="goWA('249916581517')" class="w-full bg-gray-100 p-4 rounded-xl mb-2">
      ๐ธ๐ฉ ูููุฏ ูุงุณุฑ โ ุงูุณูุฏุงู
    </button>
    <button onclick="goWA('249907760989')" class="w-full bg-red-100 p-4 rounded-xl">
      ๐ ุงููุฏูุฑ ุงูุนุงู
    </button>

    <button onclick="closeAgents()" class="w-full mt-4 text-sm text-gray-400">ุฑุฌูุน</button>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E",
  authDomain: "khasmshop.firebaseapp.com",
  projectId: "khasmshop"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let userData = null;
let activeProduct = null;
let waType = "support";

/* LOGIN */
window.login = ()=>signInWithPopup(auth,provider);

/* LEVEL SYSTEM */
function getLevel(t){
  if(t>=3000) return "ูุงุณู";
  if(t>=2000) return "ุจูุงุชููู";
  if(t>=1500) return "ุฐูุจู";
  if(t>=900) return "ูุถู";
  return "ุจุฑููุฒู";
}
function getDiscount(l){
  return {ุจุฑููุฒู:0,ูุถู:.03,ุฐูุจู:.06,ุจูุงุชููู:.09,ูุงุณู:.12}[l];
}

/* AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user) return;
  intro.classList.add("hidden");
  app.classList.remove("hidden");

  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    userData = {
      name:user.displayName,
      img:user.photoURL,
      wallet:Math.floor(100000+Math.random()*900000),
      balance:0,
      totalUC:0,
      level:"ุจุฑููุฒู",
      role:"user"
    };
    await setDoc(ref,userData);
  }else{
    userData = snap.data();
  }

  renderUser();
  loadProducts();

  if(userData.role==="admin"){
    adminPanel.classList.remove("hidden");
    loadOrders();
  }
});

/* UI */
function renderUser(){
  uImg.src=userData.img;
  uName.innerText=userData.name;
  uWallet.innerText="#"+userData.wallet;
  uBalance.innerText=userData.balance+" ุฌ.ุณ";
  uLevel.innerText=userData.level;
}

/* PRODUCTS */
function loadProducts(){
  const prods=[
    {name:"60 UC",price:4000,uc:60},
    {name:"325 UC",price:20000,uc:325},
    {name:"660 UC",price:40000,uc:660},
    {name:"1800 UC",price:100000,uc:1800}
  ];
  products.innerHTML="";
  prods.forEach(p=>{
    const final=Math.round(p.price-p.price*getDiscount(userData.level));
    products.innerHTML+=`
    <div class="bg-white p-3 rounded-xl text-center shadow">
      <p class="font-black">${p.name}</p>
      <p class="text-green-600 font-black">${final} ุฌ.ุณ</p>
      <button onclick='openOrder(${JSON.stringify(p)})'
      class="mt-2 bg-black text-white w-full p-2 rounded">ุทูุจ</button>
    </div>`;
  });
}

/* ORDER */
window.openOrder=p=>{
  activeProduct=p;
  orderTitle.innerText=p.name;
  orderModal.classList.remove("hidden");
};
window.closeOrder=()=>orderModal.classList.add("hidden");

window.confirmOrder=async()=>{
  await addDoc(collection(db,"orders"),{
    uid:auth.currentUser.uid,
    wallet:userData.wallet,
    product:activeProduct.name,
    uc:activeProduct.uc,
    status:"ููุฏ ุงูุชูููุฐ",
    date:new Date()
  });
  alert("โ ุชู ุฅุฑุณุงู ุงูุทูุจ");
  closeOrder();
};

/* ADMIN */
async function loadOrders(){
  const q=await getDocs(collection(db,"orders"));
  orders.innerHTML="";
  q.forEach(d=>{
    const o=d.data();
    orders.innerHTML+=`<div class="border p-2 mb-2">${o.product}</div>`;
  });
}

window.chargeUser=async()=>{
  const w=chargeWallet.value;
  const amt=+chargeAmount.value;
  const uc=+chargeUC.value;

  const users=await getDocs(collection(db,"users"));
  users.forEach(async d=>{
    if(d.data().wallet==w){
      const total=d.data().totalUC+uc;
      await updateDoc(doc(db,"users",d.id),{
        balance:d.data().balance+amt,
        totalUC:total,
        level:getLevel(total)
      });
      alert("ุชู ุงูุดุญู ุจูุฌุงุญ");
    }
  });
};

/* WHATSAPP */
window.openWABox=()=>waBox.classList.remove("hidden");
window.closeWABox=()=>waBox.classList.add("hidden");
window.openAgents=t=>{waType=t;waBox.classList.add("hidden");agentsBox.classList.remove("hidden");};
window.closeAgents=()=>agentsBox.classList.add("hidden");

window.goWA=phone=>{
  const msg=`ูุฑุญุจุงู ุฎุตู ุดูุจ ๐ซ
ุฃุฑูุฏ ${waType==="charge"?"ุดุญู ูุญูุธุชู":"ุงูุฏุนู ุงูููู"}

ุฑูู ูุญูุธุชู: #${userData.wallet}`;
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`);
};
</script>

</body>
        </html>
