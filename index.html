<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø®ØµÙ… | KHASM SHOP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --gold: #f59e0b;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --bg-dark: #050505;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            margin: 0;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(245, 158, 11, 0.07) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(245, 158, 11, 0.07) 0%, transparent 50%);
            background-attachment: fixed;
        }

        /* Ù†Ø³ÙŠØ¬ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ† Ø§Ù„ÙØ®Ù… */
        .carbon-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            opacity: 0.15;
            z-index: -1;
            pointer-events: none;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ© */
        .royal-card {
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 30px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .royal-card:hover {
            border-color: var(--gold);
            transform: translateY(-8px);
            box-shadow: 0 15px 45px rgba(0,0,0,0.8), 0 0 15px var(--gold-glow);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© */
        .gold-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
            color: #000;
            font-weight: 900;
            border-radius: 18px;
            padding: 18px;
            width: 100%;
            cursor: pointer;
            border: none;
            transition: 0.3s;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.3);
            text-transform: uppercase;
        }

        .gold-btn:hover {
            filter: brightness(1.2);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }

        .gold-btn:active { transform: scale(0.97); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .nav-bar {
            position: fixed;
            bottom: 25px;
            left: 20px;
            right: 20px;
            height: 80px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 35px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #444;
            font-size: 10px;
            font-weight: 800;
            transition: 0.3s;
        }

        .nav-item.active {
            color: var(--gold);
            transform: translateY(-5px);
        }

        .nav-item i { font-size: 24px; }

        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; animation: slideIn 0.5s ease-out forwards; }
        .page.active { display: block; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input, select {
            background: rgba(0,0,0,0.6) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            color: #fff !important;
            border-radius: 15px;
            padding: 16px;
            width: 100%;
            outline: none;
            margin-bottom: 12px;
            transition: 0.3s;
        }

        input:focus { border-color: var(--gold) !important; background: rgba(0,0,0,0.8) !important; }

        /* Ø§Ù„Ø£ÙˆØ³Ù…Ø© (Status Badges) */
        .badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .badge-pending { background: #7c2d12; color: #fb923c; }
        .badge-success { background: #064e3b; color: #34d399; }
        .badge-failed { background: #7f1d1d; color: #f87171; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .glitch-text {
            font-size: 80px;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold-glow);
            letter-spacing: 5px;
            font-style: italic;
        }

        #recaptcha-container { margin-top: 10px; }
    </style>
</head>
<body class="pb-36">
    <div class="carbon-bg"></div>

    <div id="login-screen" class="fixed inset-0 p-8 text-center">
        <div class="mb-12">
            <h1 class="glitch-text">KHASM</h1>
            <p class="text-gray-500 tracking-[10px] text-[10px] uppercase font-bold">The Gaming Empire</p>
        </div>

        <div class="w-full max-w-sm space-y-4">
            <button id="btn-google" class="w-full bg-white text-black py-4 rounded-2xl font-black flex items-center justify-center gap-3 shadow-xl hover:bg-amber-500 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="22">
                Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
            </button>

            <div class="flex items-center gap-4 py-4">
                <div class="h-[1px] bg-white/10 flex-1"></div>
                <span class="text-gray-600 text-xs font-bold">Ø£Ùˆ</span>
                <div class="h-[1px] bg-white/10 flex-1"></div>
            </div>

            <div id="phone-box" class="space-y-3">
                <input id="phone-number" type="tel" placeholder="+249XXXXXXXXX" class="text-center">
                <button id="btn-phone" class="gold-btn">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ <i class="fas fa-phone"></i></button>
                <div id="otp-box" class="hidden space-y-3 mt-4">
                    <input id="otp-code" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…" class="text-center border-amber-500/50">
                    <button id="btn-verify" class="gold-btn bg-green-600">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-check-circle"></i></button>
                </div>
            </div>
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <header class="p-6 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-xl z-50 border-b border-white/5">
        <div>
            <h2 class="text-2xl font-black italic text-amber-500">KHASM SHOP</h2>
            <p id="user-name" class="text-[9px] text-gray-500 font-bold uppercase mt-1">Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="bg-amber-500/10 px-4 py-2 rounded-2xl border border-amber-500/20 text-center">
                <span id="user-points" class="text-2xl font-black text-amber-500 block leading-none">0</span>
                <span class="text-[8px] font-bold text-amber-200/50 uppercase">Ù†Ù‚Ø·Ø©</span>
            </div>
            <button onclick="logout()" class="w-10 h-10 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </header>

    <main class="p-5 max-w-2xl mx-auto">
        <section id="shop" class="page active space-y-10">
            <div class="royal-card bg-gradient-to-l from-amber-900/20 to-transparent border-r-4 border-amber-500">
                <h3 class="text-xl font-black mb-1">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø®ØµÙ… ğŸ‘‘</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase">ÙƒÙ„ 30 Ù†Ù‚Ø·Ø© ØªÙ…Ù†Ø­Ùƒ 60 Ø´Ø¯Ø© Ù…Ø¬Ø§Ù†ÙŠØ©. Ø§Ø´Ø­Ù† ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø¢Ù†!</p>
            </div>

            <div id="store-sections" class="space-y-12">
                <div>
                    <h3 class="text-lg font-black mb-6 flex items-center gap-3"><i class="fas fa-bolt text-amber-500"></i> Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                    <div id="items-direct" class="grid gap-6"></div>
                </div>
                <div>
                    <h3 class="text-lg font-black mb-6 flex items-center gap-3"><i class="fas fa-id-card text-amber-500"></i> Ø´Ø­Ù† Ø§Ù„Ø£ÙŠØ¯ÙŠ</h3>
                    <div id="items-id" class="grid gap-6"></div>
                </div>
                <div>
                    <h3 class="text-lg font-black mb-6 flex items-center gap-3"><i class="fas fa-gem text-amber-500"></i> Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ù†Ø®Ø¨Ø©</h3>
                    <div id="items-subs" class="grid gap-6"></div>
                </div>
            </div>
        </section>

        <section id="orders" class="page space-y-6">
            <h3 class="text-xl font-black border-r-4 border-amber-500 pr-4">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <div id="my-orders-list" class="space-y-4">
                <div class="text-center py-20 opacity-20"><i class="fas fa-box-open text-6xl mb-4"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</p></div>
            </div>
        </section>

        <section id="rewards" class="page text-center pt-10">
            <div class="royal-card p-12 border-amber-500/20 relative overflow-hidden">
                <i class="fas fa-crown text-8xl text-amber-500/20 absolute -top-5 -right-5"></i>
                <h2 class="text-3xl font-black mb-12">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h2>
                <div class="bg-black/60 p-8 rounded-[40px] border border-white/5 mb-10">
                    <p class="text-[10px] text-gray-500 font-bold uppercase mb-2">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                    <span id="points-big" class="text-7xl font-black text-amber-500">0</span>
                </div>
                <input id="reward-pid" type="number" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ù‡Ø¯ÙŠØ©" class="text-center mb-6">
                <button onclick="redeemGift()" class="gold-btn text-xl">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 30 Ù†Ù‚Ø·Ø© Ø¨Ù€ 60 UC âœ¨</button>
            </div>
        </section>

        <section id="admin" class="page space-y-10">
            <div class="flex justify-between items-center border-b border-white/10 pb-6">
                <h2 class="text-2xl font-black text-amber-500">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
                <span class="badge bg-red-600">Admin Mode</span>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
                <div id="admin-orders-list" class="grid gap-5"></div>
            </div>

            <div id="master-controls" class="hidden pt-10 border-t border-white/10">
                <h3 class="text-lg font-black mb-6 text-green-500">Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù… Ù„Ù„Ù…ØªØ¬Ø±</h3>
                <div class="royal-card space-y-4">
                    <select id="new-type"><option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø±</option><option value="id">Ø´Ø­Ù† Ø¢ÙŠØ¯ÙŠ</option><option value="subs">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</option></select>
                    <input id="new-amt" type="text" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: 660 UC)">
                    <input id="new-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡">
                    <button onclick="pushPackage()" class="gold-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØªØ¬Ø± â•</button>
                </div>
                <div id="manage-pkgs" class="mt-8 space-y-2 opacity-50 text-[10px]"></div>
            </div>
        </section>
    </main>

    <div id="rating-popup" class="fixed inset-0 bg-black/95 z-[10001] hidden flex items-center justify-center p-6">
        <div class="royal-card p-10 w-full max-w-sm text-center border-amber-500">
            <h3 class="text-2xl font-black mb-8 text-amber-500">ÙƒÙŠÙ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨ØªÙƒØŸ</h3>
            <div class="flex justify-center gap-4 text-4xl mb-12" id="stars-row">
                <i class="fas fa-star text-gray-800 cursor-pointer" data-v="1"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" data-v="2"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" data-v="3"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" data-v="4"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" data-v="5"></i>
            </div>
            <button id="send-rating" class="gold-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ‘‘</button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="nav('shop')" id="n-shop" class="nav-item active"><i class="fas fa-store"></i>Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button onclick="nav('rewards')" id="n-rewards" class="nav-item"><i class="fas fa-gem"></i>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
        <button onclick="nav('orders')" id="n-orders" class="nav-item"><i class="fas fa-history"></i>Ø·Ù„Ø¨Ø§ØªÙŠ</button>
        <button onclick="nav('admin')" id="n-admin" class="nav-item hidden text-red-500"><i class="fas fa-user-shield"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© (Firebase Config)
        const firebaseConfig = { 
            apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", 
            authDomain: "khasmshop.firebaseapp.com", 
            databaseURL: "https://khasmshop-default-rtdb.firebaseio.com", 
            projectId: "khasmshop" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        const MASTER_EMAIL = "mhmdfthu98@gmail.com";
        const STAFF_EMAILS = [
            "mohnadyasir43@gmail.com", 
            "muhammedaltaj111@gmail.com" // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ§Ø¬ Ø­Ù…Ø²Ø© Ù…Ø¶ÙˆÙŠ
        ];

        let currentUser = null;
        let confirmationResult = null;
        let activeRatingKey = null;
        let lastKnownOrderCount = 0;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        
        // Ø¯Ø®ÙˆÙ„ Ø¬ÙˆØ¬Ù„
        document.getElementById('btn-google').onclick = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert("ÙØ´Ù„ Ø¯Ø®ÙˆÙ„ Ø¬ÙˆØ¬Ù„: " + err.message));
        };

        // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ
        const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
        
        document.getElementById('btn-phone').onclick = () => {
            const phone = document.getElementById('phone-number').value;
            if(!phone.startsWith('+')) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© (+249...)");
            
            signInWithPhoneNumber(auth, phone, recaptchaVerifier).then(result => {
                confirmationResult = result;
                document.getElementById('otp-box').classList.remove('hidden');
                document.getElementById('btn-phone').classList.add('hidden');
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚!");
            }).catch(err => alert("Ø®Ø·Ø£: " + err.message));
        };

        document.getElementById('btn-verify').onclick = () => {
            const code = document.getElementById('otp-code').value;
            confirmationResult.confirm(code).catch(err => alert("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!"));
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-name').innerText = user.displayName || user.phoneNumber;
                
                const email = user.email ? user.email.toLowerCase() : "";
                if(email === MASTER_EMAIL || STAFF_EMAILS.includes(email)) {
                    document.getElementById('n-admin').classList.remove('hidden');
                    if(email === MASTER_EMAIL) document.getElementById('master-controls').classList.remove('hidden');
                }
                startSync();
            }
        });

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø© ---
        window.nav = id => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('n-'+id).classList.add('active');
        };

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

        function startSync() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªØ¬Ø±
            onValue(ref(db, 'packages'), snap => {
                const containers = { direct: 'items-direct', id: 'items-id', subs: 'items-subs' };
                Object.values(containers).forEach(c => document.getElementById(c).innerHTML = '');
                const mList = document.getElementById('manage-pkgs');
                mList.innerHTML = '';

                snap.forEach(child => {
                    const d = child.val(), k = child.key;
                    const html = `
                    <div class="royal-card">
                        <div class="flex justify-between items-center mb-6">
                            <div><h4 class="text-2xl font-black">${d.amount}</h4><p class="text-amber-500 font-bold">${d.price} SDG</p></div>
                            <div class="w-12 h-12 bg-amber-500/10 rounded-full flex items-center justify-center text-amber-500"><i class="fas fa-shopping-cart"></i></div>
                        </div>
                        <select id="agent-${k}" class="text-[11px] font-bold">
                            <option value="249907760989">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø¬Ù…ÙˆØ¯ (ÙƒØ§Ø´/Ø¨Ù†Ùƒ)</option>
                            <option value="249914178935">ğŸ›¡ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù‡Ù†Ø¯ ÙŠØ§Ø³Ø±</option>
                            <option value="0916581517">ğŸ›¡ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ§Ø¬ Ø­Ù…Ø²Ø©</option>
                        </select>
                        <input id="pid-${k}" type="number" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="text-center font-black">
                        <button onclick="createOrder('${d.amount}','${d.price}','${k}')" class="gold-btn">Ø´Ø­Ù† ÙÙˆØ±ÙŠ âš¡</button>
                    </div>`;
                    if(containers[d.type]) document.getElementById(containers[d.type]).innerHTML += html;
                    if(currentUser.email === MASTER_EMAIL) mList.innerHTML += `<div class="flex justify-between p-2 bg-white/5 mb-1 rounded"><span>${d.amount}</span><button onclick="removePkg('${k}')" class="text-red-500">Ø­Ø°Ù</button></div>`;
                });
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            onValue(ref(db, 'orders'), snap => {
                const uList = document.getElementById('my-orders-list');
                const aList = document.getElementById('admin-orders-list');
                uList.innerHTML = ''; aList.innerHTML = '';

                // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡)
                    if(snap.numChildren() > lastKnownOrderCount && lastKnownOrderCount !== 0) {
                    const email = currentUser.email ? currentUser.email.toLowerCase() : "";
                    if(email === MASTER_EMAIL || STAFF_EMAILS.includes(email)) {
                        new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play();
                    }
                }
                lastKnownOrderCount = snap.numChildren();

                snap.forEach(child => {
                    const v = child.val(), k = child.key;
                    const statusClass = v.status.includes('ØªÙ…') ? 'badge-success' : (v.status.includes('ÙØ´Ù„') ? 'badge-failed' : 'badge-pending');

                    // Ù„Ù„Ø²Ø¨ÙˆÙ†
                    if(v.uid === currentUser.uid) {
                        uList.innerHTML += `
                        <div class="royal-card flex justify-between items-center border-r-4 ${v.status.includes('ØªÙ…')?'border-green-600':'border-amber-600'}">
                            <div><b class="text-lg">${v.amount}</b><br><span class="badge ${statusClass}">${v.status}</span></div>
                            <div class="text-right"><p class="text-[9px] text-gray-500">${v.date}</p><p class="text-xs font-black text-amber-500">${v.rating ? 'â­ '+v.rating : 'ID: '+v.pid}</p></div>
                        </div>`;
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ„Ù… ÙŠÙ‚ÙŠÙ… Ø¨Ø¹Ø¯
                        if(v.status === 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†' && !v.rating && !localStorage.getItem('rated_'+k)) {
                            activeRatingKey = k; 
                            document.getElementById('rating-popup').classList.remove('hidden');
                        }
                    }

                    // Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
                    const email = currentUser.email ? currentUser.email.toLowerCase() : "";
                    if(email === MASTER_EMAIL || STAFF_EMAILS.includes(email)) {
                        aList.innerHTML += `
                        <div class="royal-card border-l-4 border-amber-600">
                            <div class="flex justify-between items-start mb-2"><b>ğŸ‘¤ ${v.name}</b> <button onclick="deleteOrder('${k}')" class="text-red-900"><i class="fas fa-trash"></i></button></div>
                            <p class="text-xs font-bold text-gray-400">${v.amount} | ID: ${v.pid}</p>
                            <p class="text-[8px] text-amber-500 mt-1 uppercase">Ø¹Ù† Ø·Ø±ÙŠÙ‚: ${v.agent}</p>
                            <div class="flex gap-2 mt-4">
                                <button onclick="setStatus('${k}','${v.uid}','${v.amount}','âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†')" class="flex-1 bg-green-600 py-2 rounded-lg text-[10px] font-black">Ø¥ØªÙ…Ø§Ù…</button>
                                <button onclick="setStatus('${k}','${v.uid}','${v.amount}','â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°')" class="flex-1 bg-blue-600 py-2 rounded-lg text-[10px] font-black">ØªÙ†ÙÙŠØ°</button>
                                <button onclick="setStatus('${k}','${v.uid}','${v.amount}','âŒ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨')" class="flex-1 bg-red-600 py-2 rounded-lg text-[10px] font-black">Ø±ÙØ¶</button>
                            </div>
                        </div>`;
                    }
                });
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
            onValue(ref(db, `users/${currentUser.uid}/pts`), s => {
                const p = s.val() || 0;
                document.getElementById('user-points').innerText = p;
                document.getElementById('points-big').innerText = p;
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---

        window.createOrder = (amt, prc, k) => {
            const pid = document.getElementById('pid-'+k).value;
            const agnt = document.getElementById('agent-'+k);
            if(!pid || pid.length < 5) return alert("Ø§Ù„Ø¢ÙŠØ¯ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­!");

            const orderData = {
                uid: currentUser.uid, name: currentUser.displayName || currentUser.phoneNumber,
                amount: amt, price: prc, pid: pid, agent: agnt.options[agnt.selectedIndex].text,
                status: "â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", date: new Date().toLocaleString('ar-EG')
            };

            push(ref(db, 'orders'), orderData).then(() => {
                const msg = `ğŸ‘‘ *Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯*\n\nğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${orderData.name}\nğŸ’ *Ø§Ù„ÙƒÙ…ÙŠØ©:* ${amt}\nğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${prc} SDG\nğŸ†” *Ø§Ù„Ø¢ÙŠØ¯ÙŠ:* ${pid}\nğŸ›¡ï¸ *Ø§Ù„ÙˆÙƒÙŠÙ„:* ${orderData.agent}`;
                window.open(`https://wa.me/${agnt.value}?text=${encodeURIComponent(msg)}`);
            });
        };

        window.setStatus = (okey, uuid, amt, stat) => {
            update(ref(db, `orders/${okey}`), { status: stat });
            if(stat === 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†') {
                get(ref(db, `users/${uuid}/pts`)).then(snap => {
                    const current = snap.val() || 0;
                    const added = parseInt(amt) >= 60 ? Math.floor(parseInt(amt)/30) : 1;
                    set(ref(db, `users/${uuid}/pts`), current + added);
                });
            }
        };

        window.pushPackage = () => {
            const t = document.getElementById('new-type').value;
            const a = document.getElementById('new-amt').value;
            const p = document.getElementById('new-price').value;
            if(a && p) push(ref(db, 'packages'), { type: t, amount: a, price: p });
        };

        window.removePkg = k => remove(ref(db, `packages/${k}`));
        window.deleteOrder = k => confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ") && remove(ref(db, `orders/${k}`));

        window.redeemGift = () => {
            const pid = document.getElementById('reward-pid').value;
            if(!pid) return alert("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
            get(ref(db, `users/${currentUser.uid}/pts`)).then(s => {
                const p = s.val() || 0;
                if(p >= 30) {
                    set(ref(db, `users/${currentUser.uid}/pts`), p - 30);
                    push(ref(db, 'orders'), { 
                        uid: currentUser.uid, name: currentUser.displayName || currentUser.phoneNumber,
                        amount: "60 UC (Ù‡Ø¯ÙŠØ©)", price: "Ù†Ù‚Ø§Ø·", pid: pid, agent: "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²",
                        status: "ğŸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", date: new Date().toLocaleString()
                    });
                    alert("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
                } else alert("Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ (ØªØ­ØªØ§Ø¬ 30 Ù†Ù‚Ø·Ø©)");
            });
        };

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        let currentStars = 5;
        document.querySelectorAll('#stars-row i').forEach(star => {
            star.onclick = (e) => {
                currentStars = e.target.dataset.v;
                document.querySelectorAll('#stars-row i').forEach((s, idx) => {
                    s.className = idx < currentStars ? "fas fa-star text-amber-500" : "fas fa-star text-gray-800";
                });
            };
        });

        document.getElementById('send-rating').onclick = () => {
            if(activeRatingKey) {
                update(ref(db, `orders/${activeRatingKey}`), { rating: currentStars });
                localStorage.setItem('rated_'+activeRatingKey, '1');
                document.getElementById('rating-popup').classList.add('hidden');
            }
        };

    </script>
</body>
</html>
