<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhasmShop | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body { font-family: 'Cairo', sans-serif; background: #fff; overflow-x: hidden; scroll-behavior: smooth; }

        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¬Ø© */
        .royal-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(135deg, #ffffff 0%, #f0fff4 25%, #fff5f5 50%, #fffdf0 75%, #f0f7ff 100%);
            background-size: 400% 400%; animation: gradientMove 12s ease infinite;
        }
        @keyframes gradientMove { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }

        /* Ø§Ù„Ø¥Ù†ØªØ±Ùˆ Ø§Ù„ÙØ®Ù… */
        #intro {
            position: fixed; inset: 0; z-index: 9999; background: #0a0a0a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 1s;
        }
        .logo-gold { font-size: 4rem; font-weight: 900; background: linear-gradient(to right, #fbbf24, #fff, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„ÙØ®Ù… */
        .marquee-container { overflow: hidden; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .m-layer { white-space: nowrap; padding: 10px 0; font-weight: 900; font-size: 13px; display: flex; }
        .layer-1 { background: #2563eb; color: #fff; animation: scrollLeft 20s linear infinite; }
        .layer-2 { background: #dc2626; color: #fff; animation: scrollRight 25s linear infinite; }
        .layer-3 { background: #16a34a; color: #fff; animation: scrollLeft 30s linear infinite; }
        @keyframes scrollLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes scrollRight { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.05); border-radius: 35px; transition: 0.3s; }
        .glass:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: 900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="intro">
        <div class="logo-gold italic tracking-tighter">KHASM<span class="text-blue-600">SHOP</span></div>
        <div class="h-1 w-24 bg-blue-600 mt-4 rounded-full animate-bounce"></div>
    </div>

    <div class="royal-bg"></div>

    <div class="marquee-container sticky top-0 z-[1000]">
        <div class="m-layer layer-1">ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: 60 US Ø¨Ù€ 4000 ÙÙ‚Ø·! | Ø±ÙˆÙ…Ø§Øª ÙŠÙˆÙ…ÙŠØ© Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ø¦Ø² Ù‚ÙŠÙ…Ø© | Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø±ØªØ¨ ØªØ¨Ø¯Ø£ Ù…Ù† 3% ÙˆØªØµÙ„ Ø¥Ù„Ù‰ 12% ğŸ”¥</div>
        <div class="m-layer layer-2">âš¡ Ø´Ø­Ù† ÙÙˆØ±ÙŠ ÙˆØ¢Ù…Ù† 100% | Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ØªØ¹Ø¯Ø¯Ø© | Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ù…ØªØ§Ø­ÙˆÙ† 24 Ø³Ø§Ø¹Ø© Ù„Ø®Ø¯Ù…ØªÙƒÙ… âš¡</div>
        <div class="m-layer layer-3">ğŸ’ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙƒÙŠ: ÙƒÙ„ 30 Ù†Ù‚Ø·Ø© ØªÙ…Ù†Ø­Ùƒ 60 Ø´Ø¯Ø© Ù…Ø¬Ø§Ù†ÙŠØ© | Ø§Ø´Ø­Ù† Ø£ÙƒØ«Ø± Ù„ØªØ±ØªÙØ¹ Ø±ØªØ¨ØªÙƒ ğŸ’</div>
    </div>

    <div id="authScreen" class="fixed inset-0 z-[5000] bg-white flex items-center justify-center p-6 hidden">
        <div class="glass w-full max-w-sm p-10 text-center shadow-2xl">
            <h1 class="text-5xl font-black text-slate-900 mb-4 italic">KHASM<span class="text-blue-600">SHOP</span></h1>
            <p class="text-gray-400 font-bold mb-10">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„ØªØ¯Ø®Ù„ Ø¹Ø§Ù„Ù… Ø§Ù„ÙØ®Ø§Ù…Ø©</p>
            <button onclick="login()" class="w-full bg-slate-900 text-white p-5 rounded-[20px] font-black flex items-center justify-center gap-4 active:scale-95 transition">
                <i class="fab fa-google text-xl text-blue-400"></i> Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù‚ÙˆÙ‚Ù„ Ø¨Ù„Ø§ÙŠ
            </button>
        </div>
    </div>

    <div id="mainUI" class="hidden">
        <div class="max-w-2xl mx-auto p-4">
            <header class="flex justify-between items-center py-6">
                <div class="flex items-center gap-4">
                    <img id="uImg" class="w-16 h-16 rounded-2xl border-4 border-white shadow-xl">
                    <div>
                        <h2 id="uName" class="font-black text-xl text-slate-800 leading-tight">..</h2>
                        <div class="flex gap-2 items-center">
                            <span id="uRank" class="text-[10px] px-2 py-0.5 rounded-lg font-black text-white bg-amber-800">Ø¨Ø±ÙˆÙ†Ø²ÙŠ</span>
                            <span id="uID" class="text-blue-600 font-bold text-[11px] bg-blue-50 px-2 rounded italic">#000000</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="toggleSidebar()" class="w-12 h-12 bg-white rounded-2xl shadow-sm text-slate-800 flex items-center justify-center"><i class="fas fa-info-circle"></i></button>
                    <button onclick="logout()" class="w-12 h-12 bg-red-50 rounded-2xl shadow-sm text-red-600 flex items-center justify-center"><i class="fas fa-power-off"></i></button>
                </div>
            </header>

            <section class="glass p-8 mb-8 bg-gradient-to-br from-white to-blue-50 relative overflow-hidden">
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <p class="text-[10px] text-gray-400 font-black uppercase mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ±</p>
                        <h2 class="text-5xl font-black text-slate-900 leading-none"><span id="uBal">0</span> <span class="text-sm text-blue-600 font-bold">SDG</span></h2>
                    </div>
                    <div class="text-left">
                        <p class="text-[10px] text-gray-400 font-black mb-1">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                        <h2 class="text-2xl font-black text-green-600"><span id="uPts">0</span> â­</h2>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-8">
                    <button onclick="openAgents('recharge')" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-xs shadow-lg shadow-blue-200">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</button>
                    <button onclick="openAgents('support')" class="bg-white border-2 border-slate-100 text-slate-700 py-4 rounded-2xl font-black text-xs">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</button>
                </div>
            </section>

            <nav class="flex gap-8 mb-8 border-b border-gray-100 overflow-x-auto no-scrollbar font-black text-xs">
                <button onclick="setTab('store')" id="t-store" class="tab-active pb-4 shrink-0">Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</button>
                <button onclick="setTab('orders')" id="t-orders" class="text-gray-400 pb-4 shrink-0">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</button>
                <button id="adminBtn" onclick="setTab('admin')" class="hidden text-red-600 pb-4 shrink-0">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âš™ï¸</button>
            </nav>

            <div id="view-store" class="space-y-8">
                <div>
                    <h3 class="font-black text-slate-800 mb-4 pr-3 border-r-4 border-blue-600 italic text-sm">Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø¢ÙŠØ¯ÙŠ) âš¡</h3>
                    <div id="grid-direct" class="grid grid-cols-2 gap-4"></div>
                </div>
                <div>
                    <h3 class="font-black text-slate-800 mb-4 pr-3 border-r-4 border-red-600 italic text-sm">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø®Ø§ØµØ© ğŸ’¥</h3>
                    <div id="grid-weekly" class="grid grid-cols-2 gap-4"></div>
                </div>
                <div>
                    <h3 class="font-black text-slate-800 mb-4 pr-3 border-r-4 border-green-600 italic text-sm">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø­Ø²Ù… ğŸ’</h3>
                    <div id="grid-subs" class="grid grid-cols-2 gap-4"></div>
                </div>
            </div>

            <div id="view-orders" class="hidden space-y-4"></div>

            <div id="view-admin" class="hidden space-y-6">
                <div class="glass p-6 border-2 border-red-100 bg-red-50/30">
                    <h3 class="font-black text-red-600 mb-4 italic">Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ Ø³Ø±ÙŠØ¹</h3>
                    <input id="admWID" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ù…Ø«Ø§Ù„: 123456)" class="w-full p-4 rounded-xl mb-2 outline-none border font-bold">
                    <input id="admAmt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡" class="w-full p-4 rounded-xl mb-4 outline-none border font-bold">
                    <button onclick="adminDeposit()" class="w-full bg-red-600 text-white font-black py-4 rounded-xl shadow-xl">ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</button>
                </div>
                <div id="allOrders" class="space-y-4">
                    <h3 class="font-black text-slate-800 italic">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="buyModal" class="fixed inset-0 z-[6000] bg-black/70 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[40px] p-8 relative shadow-2xl animate-modal">
            <h3 id="buyTitle" class="font-black text-xl mb-6 text-center text-blue-600 italic">ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø­Ù†</h3>
            <div class="space-y-4">
                <input id="pPlayerID" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ (Player ID)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-black text-center border-2 border-transparent focus:border-blue-400">
                <input id="pPlayerName" placeholder="Ø§Ø³Ù…Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-black text-center border-2 border-transparent focus:border-blue-400">
                <div class="p-4 bg-slate-900 text-white rounded-2xl text-center">
                    <p class="text-[9px] text-gray-400 font-bold uppercase mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>
                    <p class="font-black">Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© Ø®ØµÙ… Ø´ÙˆØ¨</p>
                </div>
                <button id="confirmBtn" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…ØªØ¬Ø± ğŸš€</button>
                <button onclick="closeModals()" class="w-full text-gray-400 font-bold py-2 text-xs">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            </div>
        </div>
    </div>

    <div id="agentModal" class="fixed inset-0 z-[7000] bg-black/70 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[40px] p-8 text-right shadow-2xl relative" dir="rtl">
            <h3 class="font-black text-xl mb-8 text-center text-green-600 italic">Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</h3>
            <div class="space-y-4">
                <a href="https://wa.me/201550165993" class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-green-500 transition">
                    <div><p class="font-black text-sm">Ù…Ø­Ù…Ø¯ ÙØªØ­ÙŠ Ø­Ù…Ø²Ù‡</p><p class="text-[9px] text-gray-400">Ù…ØµØ± | +201550165993</p></div>
                    <i class="fab fa-whatsapp text-2xl text-green-500"></i>
                </a>
                <a href="https://wa.me/249914178935" class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-green-500 transition">
                    <div><p class="font-black text-sm">Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ§Ø¬ Ø­Ù…Ø²Ù‡</p><p class="text-[9px] text-gray-400">Ø§Ù„Ø³ÙˆØ¯Ø§Ù† | +249914178935</p></div>
                    <i class="fab fa-whatsapp text-2xl text-green-500"></i>
                </a>
                <a href="https://wa.me/249916581517" class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border-2 border-transparent hover:border-green-500 transition">
                    <div><p class="font-black text-sm">Ù…Ù‡Ù†Ø¯ ÙŠØ§Ø³Ø± Ø¨Ù„ÙˆÙ„Ù‡</p><p class="text-[9px] text-gray-400">Ø§Ù„Ø³ÙˆØ¯Ø§Ù† | +249916581517</p></div>
                    <i class="fab fa-whatsapp text-2xl text-green-500"></i>
                </a>
                <a href="https://wa.me/249907760989" class="block w-full bg-slate-900 text-white py-4 rounded-2xl text-center font-black mt-4">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ØªØ¬Ø±</a>
            </div>
            <button onclick="closeModals()" class="w-full mt-6 text-gray-300 font-bold text-xs uppercase">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-white z-[8000] shadow-2xl translate-x-[-100%] transition-transform duration-500 p-10">
        <button onclick="toggleSidebar()" class="mb-12 text-gray-300 text-3xl"><i class="fas fa-times-circle"></i></button>
        <h2 class="text-3xl font-black text-slate-800 mb-6 italic">Ù…Ù† Ù†Ø­Ù†ØŸ</h2>
        <p class="text-slate-500 font-bold leading-relaxed italic mb-10 text-sm">
            ÙÙŠ Ø®ØµÙ… Ø´ÙˆØ¨ØŒ ØµÙ…Ù…Ù†Ø§ Ù„Ùƒ Ù†Ø¸Ø§Ù…Ø§Ù‹ Ù…Ù„ÙƒÙŠØ§Ù‹ ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ÙØ®Ø§Ù…Ø©. Ù†Ø­Ù† Ù†ÙˆÙØ± Ù„Ùƒ Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ø£Ø³Ø¹Ø§Ø± Ø­ØµØ±ÙŠØ© ØªØªÙ†Ø§Ù‚Øµ ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯ ÙˆÙ„Ø§Ø¤Ùƒ Ù„Ù„Ù…ØªØ¬Ø±. Ù‡Ø¯ÙÙ†Ø§ Ù‡Ùˆ ØªÙ‚Ø¯ÙŠÙ… Ø®Ø¯Ù…Ø© Ø´Ø­Ù† ØªÙ„ÙŠÙ‚ Ø¨Ù…Ù‚Ø§Ù…Ùƒ Ø§Ù„Ø±Ø§Ù‚ÙŠ.
        </p>
        <button onclick="logout()" class="w-full bg-red-50 text-red-600 font-black py-4 rounded-2xl flex items-center justify-center gap-3"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", authDomain: "khasmshop.firebaseapp.com", projectId: "khasmshop", storageBucket: "khasmshop.firebasestorage.app", messagingSenderId: "238182001615", appId: "1:238182001615:web:d77391030a40a481b440ba" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const adminEmails = ["mhmdfthu98@gmail.com", "mohnadyasir43@gmail.com", "muhammedaltaj111@gmail.com"];

        let uData = null;

        const storeItems = [
            { cat:'direct', n:'60 US', p:4000, uc:60, pts:2 },
            { cat:'direct', n:'325 US', p:20000, uc:325, pts:10 },
            { cat:'direct', n:'660 US', p:40000, uc:660, pts:22 },
            { cat:'direct', n:'1800 US', p:100000, uc:1800, pts:60 },
            { cat:'direct', n:'3850 US', p:200000, uc:3850, pts:128 },
            { cat:'direct', n:'8100 US', p:400000, uc:8100, pts:270 },
            { cat:'weekly', n:'385 US (Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)', p:26000, uc:385, pts:12 },
            { cat:'weekly', n:'720 US (Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)', p:40000, uc:720, pts:24 },
            { cat:'subs', n:'Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø±Ø§ÙŠÙ… Ø´Ù‡Ø±', p:4500, uc:0, pts:1 },
            { cat:'subs', n:'Ø¨Ø±Ø§ÙŠÙ… Ø¨Ù„Øµ Ø´Ù‡Ø±', p:45000, uc:900, pts:30 },
            { cat:'subs', n:'Ø­Ø²Ù…Ø© Ø§Ù„Ù…ØªØ±ÙŠØ§Ù„Ø§Øª', p:13500, uc:0, pts:6 }
        ];

        function getRank(totalUC) {
            if (totalUC >= 7400) return { n:'Ù…Ø§Ø³ÙŠ', d:0.12, c:'bg-purple-600' };
            if (totalUC >= 4400) return { n:'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ', d:0.09, c:'bg-blue-600' };
            if (totalUC >= 2400) return { n:'Ø°Ù‡Ø¨ÙŠ', d:0.06, c:'bg-amber-400 text-slate-900' };
            if (totalUC >= 900) return { n:'ÙØ¶ÙŠ', d:0.03, c:'bg-slate-400' };
            return { n:'Ø¨Ø±ÙˆÙ†Ø²ÙŠ', d:0, c:'bg-amber-800' };
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('intro').style.opacity = '0';
                setTimeout(() => document.getElementById('intro').classList.add('hidden'), 1000);
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');
                initUser(user);
            } else {
                document.getElementById('intro').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
            }
        });

        async function initUser(user) {
            const ref = doc(db, "users", user.uid);
            onSnapshot(ref, (snap) => {
                if (snap.exists()) {
                    uData = snap.data();
                    updateUI();
                    if (adminEmails.includes(user.email.toLowerCase())) {
                        document.getElementById('adminBtn').classList.remove('hidden');
                        loadAdminOrders();
                    }
                } else {
                    const newU = { name: user.displayName, email: user.email, balance: 0, points: 0, totalUC: 0, walletID: Math.floor(100000 + Math.random() * 900000).toString(), img: user.photoURL };
                    setDoc(ref, newU);
                }
            });
            loadUserOrders(user.uid);
        }

        function updateUI() {
            const r = getRank(uData.totalUC || 0);
            document.getElementById('uName').innerText = uData.name;
            document.getElementById('uImg').src = uData.img;
            document.getElementById('uBal').innerText = uData.balance.toLocaleString();
            document.getElementById('uPts').innerText = uData.points || 0;
            document.getElementById('uID').innerText = `#${uData.walletID}`;
            document.getElementById('uRank').innerText = r.n;
            document.getElementById('uRank').className = `text-[10px] px-2 py-0.5 rounded-lg font-black text-white ${r.c}`;
            
            // Ø±Ù†Ø¯Ø± Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ø®ØµÙ… Ø§Ù„Ø±ØªØ¨Ø©
            renderCategory('direct', 'grid-direct', r.d);
            renderCategory('weekly', 'grid-weekly', r.d);
            renderCategory('subs', 'grid-subs', r.d);
        }

        function renderCategory(cat, gridId, discount) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = "";
            storeItems.filter(x => x.cat === cat).forEach(i => {
                const finalP = i.p * (1 - discount);
                grid.innerHTML += `
                    <div class="glass p-5 text-center relative">
                        <span class="absolute top-2 left-2 text-[8px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full font-black">+${i.pts} â­</span>
                        <p class="text-[10px] text-gray-400 font-black mb-1">${i.n}</p>
                        <p class="text-xl font-black text-slate-800">${finalP.toLocaleString()}</p>
                        ${discount > 0 ? `<p class="text-[8px] text-red-500 line-through">${i.p.toLocaleString()}</p>` : ''}
                        <button onclick="openBuyModal('${i.n}', ${finalP}, ${i.uc}, ${i.pts})" class="w-full bg-slate-900 text-white text-[10px] py-3 rounded-xl mt-3 font-black shadow-lg">Ø´Ø­Ù†</button>
                    </div>`;
            });
        }

        window.openBuyModal = (n, p, uc, pts) => {
            if (uData.balance < p) return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶.");
            document.getElementById('buyModal').classList.remove('hidden');
            document.getElementById('confirmBtn').onclick = () => createOrder(n, p, uc, pts);
        };

        async function createOrder(n, p, uc, pts) {
            const pid = document.getElementById('pPlayerID').value;
            const pName = document.getElementById('pPlayerName').value;
            if (!pid || !pName) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");

        const order = { uid:auth.currentUser.uid, uName:uData.name, walletID:uData.walletID, playerID:pid, playerName:pName, item:n, price:p, status:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', date:new Date().toLocaleString('ar-EG') };
            await addDoc(collection(db, "orders"), order);
            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-p), points: increment(pts), totalUC: increment(uc) });
            alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ³ÙˆÙ ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡ ÙÙˆØ±Ø§Ù‹.");
            closeModals();
        }

        function loadUserOrders(uid) {
            const q = query(collection(db, "orders"), where("uid", "==", uid));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('view-orders');
                div.innerHTML = snap.empty ? '<p class="text-center text-gray-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>' : '';
                snap.forEach(d => {
                    const o = d.data();
                    const statusClass = o.status === 'Ù…ÙƒØªÙ…Ù„' ? 'bg-green-100 text-green-600' : (o.status === 'ÙØ´Ù„' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600');
                    div.innerHTML += `<div class="glass p-5 flex justify-between items-center"><div class="text-right"><h4 class="font-black text-slate-800">${o.item}</h4><p class="text-[10px] text-gray-400 font-bold">${o.date}</p><p class="text-[11px] font-bold text-blue-600 mt-1 italic">Ø§Ù„Ù„Ø§Ø¹Ø¨: ${o.playerName}</p></div><span class="text-[10px] font-black px-3 py-1 rounded-lg ${statusClass}">${o.status}</span></div>`;
                });
            });
        }

        async function loadAdminOrders() {
            onSnapshot(collection(db, "orders"), (snap) => {
                const div = document.getElementById('allOrders');
                div.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    div.innerHTML += `<div class="glass p-4 text-xs space-y-2 border-l-4 border-red-500">
                        <p><b>Ø§Ù„Ø²Ø¨ÙˆÙ†:</b> ${o.uName} (#${o.walletID})</p>
                        <p><b>Ø§Ù„Ø·Ù„Ø¨:</b> ${o.item} | <b>ID:</b> ${o.playerID} (${o.playerName})</p>
                        <div class="flex gap-2"><button onclick="updStat('${d.id}', 'Ù…ÙƒØªÙ…Ù„')" class="bg-green-500 text-white p-1 px-3 rounded">Ù…ÙƒØªÙ…Ù„</button><button onclick="updStat('${d.id}', 'ÙØ´Ù„')" class="bg-red-500 text-white p-1 px-3 rounded">ÙØ´Ù„</button></div>
                    </div>`;
                });
            });
        }

        window.updStat = async (id, s) => { await updateDoc(doc(db, "orders", id), { status: s }); alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ âœ…"); };

        window.adminDeposit = async () => {
            const wid = document.getElementById('admWID').value;
            const amt = parseFloat(document.getElementById('admAmt').value);
            const q = query(collection(db, "users"), where("walletID", "==", wid));
            const s = await getDocs(q);
            if (s.empty) return alert("Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…Ø³Ø¬Ù„.");
            await updateDoc(doc(db, "users", s.docs[0].id), { balance: increment(amt) });
            alert(`ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ ${amt} Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
        };

        window.setTab = (t) => { ['store', 'orders', 'admin'].forEach(v => { document.getElementById(`view-${v}`)?.classList.add('hidden'); document.getElementById(`t-${v}`)?.classList.remove('tab-active'); document.getElementById(`t-${v}`)?.classList.add('text-gray-400'); }); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`t-${t}`).classList.add('tab-active'); document.getElementById(`t-${t}`).classList.remove('text-gray-400'); };
        window.openAgents = () => document.getElementById('agentModal').classList.remove('hidden');
        window.closeModals = () => { document.getElementById('buyModal').classList.add('hidden'); document.getElementById('agentModal').classList.add('hidden'); };
        window.toggleSidebar = () => { const s = document.getElementById('sidebar'); s.style.transform = s.style.transform === 'translateX(0%)' ? 'translateX(-100%)' : 'translateX(0%)'; };
        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
