<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø´Ø­Ù† | EMPROR ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #050505; color: white; margin: 0; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .admin-card { border-right: 4px solid #dc2626; background: rgba(220, 38, 38, 0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
    </style>
</head>
<body>

    <main class="p-4 max-w-6xl mx-auto">
        <div id="adminPanel" class="hidden glass p-6 rounded-[2.5rem] mb-10 border-2 border-red-600/20 shadow-2xl">
            <h2 class="text-center font-black text-red-500 mb-6 italic text-2xl">ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø© ğŸ‘‘</h2>
            
            <div id="ownerOnlySection" class="hidden mb-10 p-6 glass rounded-3xl border border-green-600/20">
                <h3 class="text-xs font-bold text-green-500 mb-4 border-b border-white/5 pb-2">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù„Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± ÙÙ‚Ø·)</h3>
                <div id="staffStats" class="stats-grid">
                    </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4 bg-white/5 p-6 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-400">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø²Ù…</h3>
                    <input id="pkgName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø©" class="w-full p-4 rounded-xl bg-black border border-white/10 outline-none focus:border-red-600">
                    <div class="flex gap-2">
                        <input id="pkgAmount" type="number" placeholder="UC" class="w-1/2 p-4 rounded-xl bg-black border border-white/10">
                        <input id="pkgPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-1/2 p-4 rounded-xl bg-black border border-white/10">
                    </div>
                    <button onclick="addPackage()" class="w-full bg-red-600 py-4 rounded-xl font-black">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© ğŸš€</button>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gray-400">ğŸ”” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
                    <div id="adminOrdersList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>

        <div id="userSection" class="hidden">
            <div id="packagesGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-20"></div>
            <div class="glass p-6 rounded-[2.5rem] mb-10 border border-white/5">
                <h3 class="font-black mb-4 italic text-sm text-gray-400">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙƒ ğŸ“‚</h3>
                <div id="userOrdersList" class="space-y-3"></div>
            </div>
        </div>

        <div id="loginSection" class="glass p-20 rounded-[4rem] text-center my-10 border-white/10 shadow-2xl">
            <h1 class="text-5xl font-black mb-10 italic">EMPROR<span class="text-red-600 italic">98</span></h1>
            <button onclick="login()" class="bg-white text-black px-10 py-5 rounded-2xl font-black flex items-center justify-center gap-3 mx-auto shadow-2xl">
                <img src="https://www.google.com/favicon.ico" class="w-6"> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©
            </button>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ... Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹) ...
        const firebaseConfig = {
            apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E",
            authDomain: "khasmshop.firebaseapp.com",
            databaseURL: "https://khasmshop-default-rtdb.firebaseio.com",
            projectId: "khasmshop",
            storageBucket: "khasmshop.firebasestorage.app",
            messagingSenderId: "238182001615",
            appId: "1:238182001615:web:4c7ddea335df2111b440ba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const SUPER_ADMIN = "mhmdfthu98@gmail.com";

        window.login = () => signInWithPopup(auth, provider);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userSection').classList.remove('hidden');
                
                if (user.email === SUPER_ADMIN) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('ownerOnlySection').classList.remove('hidden');
                    loadStaffStats(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                }
                loadUserOrders(user.uid);
                loadAllOrders();
                loadPackages();
            }
        });

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ "Ø¨ØµÙ…Ø© Ø§Ù„Ù…ÙˆØ¸Ù"
        window.updateStatus = async (key, status, amount) => {
            const user = auth.currentUser;
            await update(ref(db, `orders/${key}`), { 
                status: status,
                executedBy: user.displayName,
                executedEmail: user.email,
                executionDate: new Date().toLocaleString('ar-EG')
            });
            alert("ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…! âœ…");
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù„Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± ÙÙ‚Ø·)
        function loadStaffStats() {
            onValue(ref(db, 'orders'), (s) => {
                const stats = {};
                s.forEach(c => {
                    const d = c.val();
                    if (d.status === 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­' && d.executedBy) {
                        if (!stats[d.executedBy]) stats[d.executedBy] = { count: 0, totalUC: 0 };
                        stats[d.executedBy].count++;
                        stats[d.executedBy].totalUC += parseInt(d.amount);
                    }
                });

                const container = document.getElementById('staffStats');
                container.innerHTML = '';
                for (const name in stats) {
                    container.innerHTML += `
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-center">
                            <p class="text-[10px] text-red-500 font-bold mb-1">${name}</p>
                            <p class="text-xl font-black">${stats[name].count} <span class="text-[8px] text-gray-500 text-xs">Ø·Ù„Ø¨</span></p>
                            <p class="text-[9px] text-green-500 font-bold mt-1">${stats[name].totalUC} UC Ø´Ø­Ù†Ù‡Ø§</p>
                        </div>
                    `;
                }
            });
        }

        // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        function loadAllOrders() {
            onValue(ref(db, 'orders'), (s) => {
                const list = document.getElementById('adminOrdersList');
                list.innerHTML = '';
                s.forEach(c => {
                    const d = c.val();
                    const executor = d.executedBy ? `<p class="text-[9px] text-green-400 font-bold mt-1 italic underline">Ø¨ØµÙ…Ø© Ø§Ù„Ù…Ù†ÙØ°: ${d.executedBy}</p>` : '';
                    list.innerHTML += `
                        <div class="p-4 glass rounded-3xl border-r-4 ${d.executedBy ? 'border-green-600' : 'border-red-600'} mb-3">
                            <p class="text-[10px] text-red-500 font-bold">${d.userName} (${d.orderId})</p>
                            <p class="font-black text-sm">${d.amount} UC | ID: ${d.pid}</p>
                            <p class="text-[9px] text-yellow-500 font-bold">Ø§Ù„Ù…Ø±Ø¬Ø¹: ${d.pRef}</p>
                            ${executor}
                            <div class="flex gap-2 mt-4">
                                <button onclick="updateStatus('${c.key}', 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­', ${d.amount})" class="flex-1 bg-green-700 py-2 rounded-xl text-[9px] font-bold">ØªÙ… Ø§Ù„Ø´Ø­Ù† âœ…</button>
                                <button onclick="updateStatus('${c.key}', 'âŒ ÙØ´Ù„ (ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§)')" class="flex-1 bg-red-700 py-2 rounded-xl text-[9px] font-bold">ÙØ´Ù„ âŒ</button>
                                <button onclick="deleteOrder('${c.key}')" class="bg-gray-800 p-2 rounded-xl text-red-500">Ø­Ø°Ù</button>
                            </div>
                        </div>`;
                });
            });
        }

        // ... Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ (Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…ØŒ Ø´Ø­Ù†ØŒ Ø¥Ù„Ø®) ...
        window.addPackage = () => {
            const name = document.getElementById('pkgName').value;
            const amount = document.getElementById('pkgAmount').value;
            const price = document.getElementById('pkgPrice').value;
            if(name && amount && price) push(ref(db, 'packages'), { name, amount, price });
        };

        function loadPackages() {
            onValue(ref(db, 'packages'), (s) => {
                const grid = document.getElementById('packagesGrid');
                grid.innerHTML = '';
                s.forEach(c => {
                    const d = c.val();
                    grid.innerHTML += `<div class="glass p-6 rounded-[2.5rem] text-center border border-white/5">
                        <h3 class="text-sm text-gray-500 mb-1">${d.name}</h3>
                        <h2 class="text-3xl font-black mb-6">${d.amount} UC</h2>
                        <input id="id-${c.key}" type="number" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="w-full p-4 mb-2 rounded-xl bg-black border border-white/10 text-center font-bold outline-none">
                        <input id="ref-${c.key}" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹" class="w-full p-4 mb-4 rounded-xl bg-white/5 border border-dashed border-white/20 text-center text-xs outline-none">
                        <button onclick="orderNow('${d.amount}', '${d.price}', '${c.key}')" class="w-full bg-red-600 py-4 rounded-xl font-black shadow-lg">Ø´Ø­Ù† Ø§Ù„Ø¢Ù† âš¡</button>
                    </div>`;
                });
            });
        }

        window.orderNow = (amount, price, key) => {
            const pid = document.getElementById(`id-${key}`).value;
            const pref = document.getElementById(`ref-${key}`).value;
            if(!pid || !pref) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!");
            const user = auth.currentUser;
            push(ref(db, 'orders'), { 
                amount, price, pid, pRef: pref, userId: user.uid, userName: user.displayName, 
                orderId: "#EM-"+Math.floor(Math.random()*9999), date: new Date().toLocaleString('ar-EG'), status: "â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" 
            });
            window.open(`https://wa.me/249916581517?text=Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… ${pid}`);
        };

        function loadUserOrders(uid) {
            onValue(ref(db, 'orders'), (s) => {
                const list = document.getElementById('userOrdersList');
                list.innerHTML = '';
                s.forEach(c => {
                    if (c.val().userId === uid) {
                        list.innerHTML += `<div class="p-4 bg-white/5 rounded-2xl border-r-2 border-red-600 mb-2 flex justify-between items-center text-xs">
                            <span>${c.val().amount} UC - ${c.val().orderId}</span>
                            <span class="font-bold text-green-500">${c.val().status}</span>
                        </div>`;
                    }
                });
            });
        }
        window.deleteOrder = (key) => confirm('Ø­Ø°ÙØŸ') && remove(ref(db, `orders/${key}`));

    </script>
</body>
</html>
