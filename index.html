<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø®ØµÙ… | KHASM SHOP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --gold: #f59e0b;
            --gold-glow: rgba(245, 158, 11, 0.5);
            --bg-dark: #020202;
            --royal-red: #991b1b;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            margin: 0;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(245, 158, 11, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.05) 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* Ù†Ø³ÙŠØ¬ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ† Ø§Ù„Ù…Ù„ÙƒÙŠ */
        .carbon-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            opacity: 0.12;
            z-index: -1;
            pointer-events: none;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ®Ù…Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        .royal-card {
            background: linear-gradient(145deg, rgba(20, 20, 20, 0.9), rgba(10, 10, 10, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .royal-card::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            transition: 0.5s;
        }

        .royal-card:hover::before { left: 100%; }

        .royal-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 20px 50px rgba(0,0,0,0.9), 0 0 20px var(--gold-glow);
        }

        /* Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Status Animation) */
        .status-pulse {
            width: 10px; height: 10px; border-radius: 50%;
            display: inline-block; margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© */
        .bg-pending { background: linear-gradient(90deg, #b45309, #d97706); }
        .bg-processing { background: linear-gradient(90deg, #1d4ed8, #3b82f6); }
        .bg-shipped { background: linear-gradient(90deg, #065f46, #10b981); }
        .bg-failed { background: linear-gradient(90deg, #991b1b, #ef4444); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© */
        .gold-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
            color: #000; font-weight: 900; border-radius: 20px;
            padding: 18px; width: 100%; cursor: pointer; border: none;
            transition: 0.4s; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .gold-btn:hover { filter: brightness(1.2); transform: scale(1.02); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .nav-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; height: 85px;
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 40px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .nav-item {
            color: #555; transition: 0.4s; display: flex; flex-direction: column; align-items: center;
        }

        .nav-item.active { color: var(--gold); transform: translateY(-8px); }
        .nav-item i { font-size: 26px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 900; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù€ ID */
        .id-badge {
            background: rgba(255,255,255,0.05); padding: 5px 12px;
            border-radius: 10px; font-family: monospace; color: var(--gold);
        }

        /* ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .page { display: none; }
        .page.active { display: block; animation: fadeInUp 0.6s ease; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        input, select {
            background: rgba(20, 20, 20, 0.7) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            color: white !important; border-radius: 18px; padding: 16px;
            width: 100%; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--gold) !important; box-shadow: 0 0 15px var(--gold-glow); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { background: #000; z-index: 9999; }
        .empire-title { font-size: 85px; font-weight: 900; color: var(--gold); font-style: italic; text-shadow: 0 0 30px var(--gold-glow); }
    </style>
</head>
<body class="pb-40">
    <div class="carbon-bg"></div>

    <div id="login-overlay" class="fixed inset-0 flex flex-col items-center justify-center p-10 text-center">
        <div class="animate__animated animate__zoomIn">
            <h1 class="empire-title">KHASM</h1>
            <p class="text-gray-600 tracking-[12px] text-xs uppercase font-black mb-16">The Royal Gaming Shop</p>
        </div>
        
        <div class="w-full max-w-sm space-y-5">
            <button id="google-login" class="w-full bg-white text-black py-5 rounded-3xl font-black flex items-center justify-center gap-4 shadow-2xl hover:bg-amber-500 transition-all active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="24">
                Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©
            </button>
            
            <div class="flex items-center gap-4 opacity-30 px-10">
                <div class="h-[1px] bg-white flex-1"></div>
                <span class="text-[10px] font-bold">OR</span>
                <div class="h-[1px] bg-white flex-1"></div>
            </div>

            <div id="phone-login-area" class="space-y-4">
                <input id="phone-number" type="tel" placeholder="+249XXXXXXXXX" class="text-center">
                <button id="send-otp" class="gold-btn">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-shield-alt"></i></button>
                <div id="otp-area" class="hidden animate__animated animate__fadeInUp">
                    <input id="otp-code" type="number" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚" class="text-center mt-4">
                    <button id="verify-otp" class="gold-btn bg-green-600 mt-2">ØªØ£ÙƒÙŠØ¯ <i class="fas fa-check"></i></button>
                </div>
            </div>
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <header class="p-6 flex justify-between items-center sticky top-0 bg-black/60 backdrop-blur-2xl z-50 border-b border-white/5">
        <div>
            <h2 class="text-2xl font-black italic text-amber-500">KHASM SHOP</h2>
            <div id="user-info" class="flex items-center gap-2 mt-1">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <p id="display-name" class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-amber-500/10 px-5 py-2 rounded-2xl border border-amber-500/20 text-center relative">
                <span id="points-count" class="text-2xl font-black text-amber-500 block">0</span>
                <span class="text-[8px] font-bold text-amber-200/40 uppercase">Ù†Ù‚Ø·Ø© Ù…Ù„ÙƒÙŠØ©</span>
            </div>
            <button onclick="signOutUser()" class="w-12 h-12 rounded-2xl bg-red-900/20 text-red-500 border border-red-500/20 hover:bg-red-600 hover:text-white transition-all">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <main class="p-5 max-w-2xl mx-auto space-y-10">
        <section id="shop-page" class="page active space-y-10">
            <div class="royal-card bg-gradient-to-r from-amber-600/10 to-transparent">
                <h3 class="text-xl font-black mb-2">Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­ØµØ±ÙŠØ© ğŸ”¥</h3>
                <p class="text-[11px] text-gray-400 leading-relaxed font-bold uppercase">ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø­Ù† ØªÙ…Ù†Ø­Ùƒ Ù†Ù‚Ø§Ø·Ø§Ù‹ Ø­Ù‚ÙŠÙ‚ÙŠØ©. Ø§Ø³ØªØ¨Ø¯Ù„ Ù†Ù‚Ø§Ø·Ùƒ Ø¨Ø´Ø¯Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø².</p>
            </div>

            <div id="store-wrapper" class="space-y-12">
                <div>
                    <h4 class="text-sm font-black text-gray-500 uppercase tracking-[4px] mb-6 flex items-center gap-3"><i class="fas fa-bolt text-amber-500"></i> Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙÙˆØ±ÙŠ</h4>
                    <div id="list-direct" class="grid gap-6"></div>
                </div>
                <div>
                    <h4 class="text-sm font-black text-gray-500 uppercase tracking-[4px] mb-6 flex items-center gap-3"><i class="fas fa-id-card text-amber-500"></i> Ø´Ø­Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ¯ÙŠ</h4>
                    <div id="list-id" class="grid gap-6"></div>
                </div>
                <div>
                    <h4 class="text-sm font-black text-gray-500 uppercase tracking-[4px] mb-6 flex items-center gap-3"><i class="fas fa-crown text-amber-500"></i> Ø¨Ø§Ù‚Ø§Øª Ø§Ù„ÙÙŠ Ø£ÙŠ Ø¨ÙŠ</h4>
                    <div id="list-subs" class="grid gap-6"></div>
                </div>
            </div>
        </section>

        <section id="orders-page" class="page space-y-8">
            <div class="flex items-center justify-between px-2">
                <h3 class="text-2xl font-black border-r-4 border-amber-500 pr-4">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒ</h3>
                <span class="text-[10px] text-gray-500 font-bold uppercase">Real-time Sync</span>
            </div>
            <div id="user-orders-display" class="space-y-6">
                <div class="text-center py-24 opacity-20">
                    <i class="fas fa-satellite-dish text-6xl mb-4 animate-bounce"></i>
                    <p class="font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            </div>
        </section>

        <section id="rewards-page" class="page text-center pt-10">
            <div class="royal-card p-12 border-amber-500/20 shadow-amber-500/10">
                <div class="mb-10 relative">
                    <i class="fas fa-gift text-7xl text-amber-500 animate__animated animate__heartBeat animate__infinite"></i>
                    <div class="absolute inset-0 bg-amber-500 blur-3xl opacity-10"></div>
                </div>
                <h2 class="text-3xl font-black mb-12">Ù…ØªØ¬Ø± Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>
                <div class="bg-black/60 p-10 rounded-[45px] border border-white/5 mb-10">
                    <p class="text-[11px] text-gray-500 font-bold uppercase mb-4 tracking-widest">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªØ§Ø­</p>
                    <span id="pts-large" class="text-8xl font-black text-amber-500 tracking-tighter">0</span>
                </div>
                <input id="gift-player-id" type="number" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ø³ØªÙ„Ù…" class="text-center mb-6">
                <button onclick="claimReward()" class="gold-btn py-6 text-xl">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 30 Ù†Ù‚Ø·Ø© Ø¨Ù€ 60 UC âœ¨</button>
                <p class="mt-8 text-[10px] text-gray-600 font-bold uppercase tracking-widest">ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</p>
            </div>
        </section>

        <section id="admin-page" class="page space-y-12">
            <div class="flex justify-between items-center border-b border-white/10 pb-8">
                <div>
                    <h2 class="text-3xl font-black text-amber-500">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                    <p class="text-[10px] text-gray-500 font-bold mt-1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
                </div>
                <div class="flex gap-2">
                    <span class="bg-red-500/10 text-red-500 text-[10px] px-4 py-2 rounded-full font-black border border-red-500/20">MASTER</span>
                </div>
            </div>

            <div class="space-y-6">
                <h4 class="text-xs font-black text-amber-500/50 uppercase tracking-[5px] flex items-center gap-2">
                    <i class="fas fa-stream"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                </h4>
                <div id="admin-orders-display" class="grid gap-6"></div>
            </div>

            <div id="master-only-tools" class="hidden pt-12 border-t border-white/10">
                <h4 class="text-lg font-black mb-8 text-green-500 flex items-center gap-3">
                    <i class="fas fa-plus-circle"></i> ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¬Ø±
                </h4>
                <div class="royal-card space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="new-item-type">
                            <option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø±</option>
                            <option value="id">Ø´Ø­Ù† Ø¢ÙŠØ¯ÙŠ</option>
                            <option value="subs">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</option>
                        </select>
                        <input id="new-item-amt" type="text" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: 660 UC)">
                    </div>
                    <input id="new-item-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDG)">
                    <button onclick="addPackageToStore()" class="gold-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØªØ¬Ø± â•</button>
                </div>
                <div id="manage-items-list" class="mt-10 grid grid-cols-1 gap-3 opacity-40"></div>
            </div>
        </section>
    </main>

    <div id="rating-modal" class="fixed inset-0 bg-black/98 z-[10001] hidden flex items-center justify-center p-8">
        <div class="royal-card p-12 w-full max-w-sm text-center border-amber-500 shadow-2xl">
            <div class="mb-10"><i class="fas fa-check-circle text-7xl text-green-500 animate-bounce"></i></div>
            <h3 class="text-2xl font-black mb-4">Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©!</h3>
            <p class="text-gray-500 text-xs font-bold mb-10 uppercase tracking-widest">Ù‚ÙŠÙ… Ø®Ø¯Ù…ØªÙ†Ø§ Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©</p>
            <div class="flex justify-center gap-4 text-4xl mb-12" id="rating-stars">
                <i class="fas fa-star text-gray-800 cursor-pointer transition-all hover:scale-125" data-val="1"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer transition-all hover:scale-125" data-val="2"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer transition-all hover:scale-125" data-val="3"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer transition-all hover:scale-125" data-val="4"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer transition-all hover:scale-125" data-val="5"></i>
            </div>
            <button id="submit-review" class="gold-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ‘‘</button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="switchTab('shop')" id="t-shop" class="nav-item active">
            <i class="fas fa-store-alt"></i><span>Ø§Ù„Ù…ØªØ¬Ø±</span>
        </button>
        <button onclick="switchTab('rewards')" id="t-rewards" class="nav-item">
            <i class="fas fa-crown"></i><span>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</span>
        </button>
        <button onclick="switchTab('orders')" id="t-orders" class="nav-item">
            <i class="fas fa-history"></i><span>ØªØªØ¨Ø¹ÙŠ</span>
        </button>
        <button onclick="switchTab('admin')" id="t-admin" class="nav-item hidden">
            <i class="fas fa-user-shield"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Firebase Config)
        const firebaseConfig = { 
            apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", 
            authDomain: "khasmshop.firebaseapp.com", 
            databaseURL: "https://khasmshop-default-rtdb.firebaseio.com", 
            projectId: "khasmshop" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const ADMIN_MASTER = "mhmdfthu98@gmail.com";
        const STAFF_LIST = ["mohnadyasir43@gmail.com", "muhammedaltaj111@gmail.com"];

        let userState = null;
        let phoneConfirmation = null;
        let lastOrderRef = null;
        let totalOrders = 0;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ---

        document.getElementById('google-login').onclick = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(e => alert("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message));
        };

        const verifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
        
        document.getElementById('send-otp').onclick = () => {
            const num = document.getElementById('phone-number').value;
            if(!num.includes('+')) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹ (+249)");
            signInWithPhoneNumber(auth, num, verifier).then(res => {
                phoneConfirmation = res;
                document.getElementById('otp-area').classList.remove('hidden');
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚!");
            }).catch(e => alert(e.message));
        };

        document.getElementById('verify-otp').onclick = () => {
            phoneConfirmation.confirm(document.getElementById('otp-code').value).catch(e => alert("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!"));
        };

        window.signOutUser = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, u => {
            if(u) {
                userState = u;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('display-name').innerText = u.displayName || u.phoneNumber;
                
                const email = u.email ? u.email.toLowerCase() : "";
                if(email === ADMIN_MASTER || STAFF_LIST.includes(email)) {
                    document.getElementById('t-admin').classList.remove('hidden');
                    if(email === ADMIN_MASTER) document.getElementById('master-only-tools').classList.remove('hidden');
                }
                initEmpireSystem();
            }
        });

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ---

        window.switchTab = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            };

        // --- Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠ (Real-time Core) ---

        function initEmpireSystem() {
            // 1. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªØ¬Ø±
            onValue(ref(db, 'packages'), snap => {
                const lists = { direct: 'list-direct', id: 'list-id', subs: 'list-subs' };
                Object.values(lists).forEach(l => document.getElementById(l).innerHTML = '');
                const manage = document.getElementById('manage-items-list');
                manage.innerHTML = '';

                snap.forEach(child => {
                    const data = child.val(), key = child.key;
                    const itemHtml = `
                    <div class="royal-card animate__animated animate__fadeIn">
                        <div class="flex justify-between items-center mb-6">
                            <div><h5 class="text-2xl font-black">${data.amount}</h5><p class="text-amber-500 font-black">${data.price} SDG</p></div>
                            <div class="w-14 h-14 bg-amber-500/10 rounded-3xl flex items-center justify-center text-amber-500 text-xl border border-amber-500/10"><i class="fas fa-shopping-bag"></i></div>
                        </div>
                        <select id="agent-for-${key}" class="text-[11px] font-black mb-4">
                            <option value="249907760989">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø¬Ù…ÙˆØ¯ (Ø¨Ù†ÙƒÙƒ/ÙƒØ§Ø´)</option>
                            <option value="249914178935">ğŸ›¡ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù‡Ù†Ø¯ ÙŠØ§Ø³Ø±</option>
                            <option value="0916581517">ğŸ›¡ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ§Ø¬ Ø­Ù…Ø²Ø©</option>
                        </select>
                        <input id="pid-for-${key}" type="number" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="text-center font-black text-xl tracking-[4px]">
                        <button onclick="submitOrder('${data.amount}','${data.price}','${key}')" class="gold-btn mt-4">Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¢Ù† ğŸš€</button>
                    </div>`;
                    if(lists[data.type]) document.getElementById(lists[data.type]).innerHTML += itemHtml;
                    if(userState.email === ADMIN_MASTER) manage.innerHTML += `<div class="flex justify-between items-center bg-white/5 p-3 rounded-xl"><span>${data.amount}</span><button onclick="deletePackage('${key}')" class="text-red-500 font-black">Ø­Ø°Ù</button></div>`;
                });
            });

            // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØªØ¨Ø¹ (Ù„Ù„Ø²Ø¨ÙˆÙ† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©)
            onValue(ref(db, 'orders'), snap => {
                const uDisplay = document.getElementById('user-orders-display');
                const aDisplay = document.getElementById('admin-orders-display');
                uDisplay.innerHTML = ''; aDisplay.innerHTML = '';

                // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†)
                if(snap.numChildren() > totalOrders && totalOrders !== 0) {
                    const email = userState.email ? userState.email.toLowerCase() : "";
                    if(email === ADMIN_MASTER || STAFF_LIST.includes(email)) {
                        new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play();
                    }
                }
                totalOrders = snap.numChildren();

                snap.forEach(child => {
                    const o = child.val(), k = child.key;
                    let sClass = "bg-pending", sIcon = "fa-clock", sPulse = "rgba(245, 158, 11, 0.7)";
                    
                    if(o.status.includes('ØªÙ†ÙÙŠØ°')) { sClass = "bg-processing"; sIcon = "fa-cogs"; sPulse = "rgba(59, 130, 246, 0.7)"; }
                    if(o.status.includes('ØªÙ…')) { sClass = "bg-shipped"; sIcon = "fa-check-double"; sPulse = "rgba(16, 185, 129, 0.7)"; }
                    if(o.status.includes('ÙØ´Ù„')) { sClass = "bg-failed"; sIcon = "fa-times-circle"; sPulse = "rgba(239, 68, 68, 0.7)"; }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨ÙˆÙ†
                    if(o.uid === userState.uid) {
                        uDisplay.innerHTML += `
                        <div class="royal-card border-r-8 ${o.status.includes('ØªÙ…')?'border-green-600':'border-amber-600'} animate__animated animate__slideInRight">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="text-xl font-black">${o.amount}</h5>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="status-pulse" style="box-shadow: 0 0 0 0 ${sPulse}"></span>
                                        <span class="badge ${sClass} px-3 py-1 rounded-lg text-[10px] font-black text-white uppercase">${o.status}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[9px] text-gray-500 font-bold mb-1">${o.time}</p>
                                    <span class="id-badge text-sm">${o.pid}</span>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-white/5 flex justify-between items-center">
                                <span class="text-[10px] text-gray-600 font-black uppercase tracking-widest">Ø§Ù„ÙˆÙƒÙŠÙ„: ${o.agent}</span>
                                ${o.rating ? `<span class="text-amber-500 font-black">â­ ${o.rating}</span>` : ''}
                            </div>
                        </div>`;
                        
                        // ÙØªØ­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„
                        if(o.status === "âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†" && !o.rating && !localStorage.getItem('rated_'+k)) {
                            lastOrderRef = k; document.getElementById('rating-modal').classList.remove('hidden');
                        }
                    }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                    const email = userState.email ? userState.email.toLowerCase() : "";
                    if(email === ADMIN_MASTER || STAFF_LIST.includes(email)) {
                        aDisplay.innerHTML += `
                        <div class="royal-card border-l-4 border-amber-600">
                            <div class="flex justify-between mb-4">
                                <b>ğŸ‘¤ ${o.customer}</b>
                                <button onclick="removeOrder('${k}')" class="text-red-900 opacity-30"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl mb-4">
                                <span class="text-amber-500 font-black">${o.amount}</span>
                                <span class="id-badge">${o.pid}</span>
                            </div>
                            <p class="text-[8px] text-gray-500 mb-4 uppercase tracking-[2px]">Ø§Ù„ÙˆÙƒÙŠÙ„: ${o.agent} ${o.rating ? '| Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: â­ '+o.rating : ''}</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="updateOrderStatus('${k}','${o.uid}','${o.amount}','âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†')" class="bg-green-600 py-2 rounded-lg text-[9px] font-black">Ø¥ØªÙ…Ø§Ù…</button>
                                <button onclick="updateOrderStatus('${k}','${o.uid}','${o.amount}','â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°')" class="bg-blue-600 py-2 rounded-lg text-[9px] font-black">ØªÙ†ÙÙŠØ°</button>
                                <button onclick="updateOrderStatus('${k}','${o.uid}','${o.amount}','âŒ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨')" class="bg-red-600 py-2 rounded-lg text-[9px] font-black">ÙØ´Ù„</button>
                            </div>
                        </div>`;
                    }
                });
            });

            // 3. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
            onValue(ref(db, `users/${userState.uid}/pts`), s => {
                const p = s.val() || 0;
                document.getElementById('points-count').innerText = p;
                document.getElementById('pts-large').innerText = p;
            });
        }

            // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---

        window.submitOrder = (amount, price, key) => {
            const pid = document.getElementById('pid-for-'+key).value;
            const agentSelect = document.getElementById('agent-for-'+key);
            if(!pid || pid.length < 5) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID ØµØ­ÙŠØ­!");

            const orderData = {
                uid: userState.uid, customer: userState.displayName || userState.phoneNumber,
                amount: amount, price: price, pid: pid, agent: agentSelect.options[agentSelect.selectedIndex].text,
                status: "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", time: new Date().toLocaleString('ar-EG')
            };

            push(ref(db, 'orders'), orderData).then(() => {
                const whatsappMsg = `ğŸ‘‘ *Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ Ù…Ù† KHASM SHOP*\n\nğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${orderData.customer}\nğŸ’ *Ø§Ù„ÙƒÙ…ÙŠØ©:* ${amount}\nğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${price} SDG\nğŸ†” *Ø§Ù„Ø£ÙŠØ¯ÙŠ:* ${pid}\nğŸ›¡ï¸ *Ø§Ù„ÙˆÙƒÙŠÙ„:* ${orderData.agent}`;
                window.open(`https://wa.me/${agentSelect.value}?text=${encodeURIComponent(whatsappMsg)}`);
            });
        };

        window.updateOrderStatus = (oid, uuid, amt, newStatus) => {
            update(ref(db, `orders/${oid}`), { status: newStatus });
            if(newStatus === "âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†") {
                get(ref(db, `users/${uuid}/pts`)).then(snap => {
                    const current = snap.val() || 0;
                    const bonus = parseInt(amt) >= 60 ? Math.floor(parseInt(amt)/30) : 1;
                    set(ref(db, `users/${uuid}/pts`), current + bonus);
                });
            }
        };

        window.addPackageToStore = () => {
            const type = document.getElementById('new-item-type').value;
            const amt = document.getElementById('new-item-amt').value;
            const prc = document.getElementById('new-item-price').value;
            if(amt && prc) push(ref(db, 'packages'), { type, amount: amt, price: prc });
        };

        window.deletePackage = k => remove(ref(db, `packages/${k}`));
        window.removeOrder = k => confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ") && remove(ref(db, `orders/${k}`));

        window.claimReward = () => {
            const pid = document.getElementById('gift-player-id').value;
            if(!pid) return alert("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ø³ØªÙ„Ù…!");
            get(ref(db, `users/${userState.uid}/pts`)).then(s => {
                const p = s.val() || 0;
                if(p >= 30) {
                    set(ref(db, `users/${userState.uid}/pts`), p - 30);
                    push(ref(db, 'orders'), { 
                        uid: userState.uid, customer: userState.displayName || userState.phoneNumber,
                        amount: "60 UC (Ø¬Ø§Ø¦Ø²Ø©)", price: "Ù†Ù‚Ø§Ø·", pid: pid, agent: "Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
                        status: "ğŸ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‡Ø¯ÙŠØ©", time: new Date().toLocaleString()
                    });
                    alert("ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·! Ø³ÙŠØªÙ… Ø§Ù„Ø´Ø­Ù† Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
                } else alert("Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ© (ØªØ­ØªØ§Ø¬ 30 Ù†Ù‚Ø·Ø©)");
            });
        };

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ
        let selectedStars = 5;
        document.querySelectorAll('#rating-stars i').forEach(star => {
            star.onclick = (e) => {
                selectedStars = e.target.dataset.val;
                document.querySelectorAll('#rating-stars i').forEach((s, idx) => {
                    s.className = idx < selectedStars ? "fas fa-star text-amber-500 scale-125" : "fas fa-star text-gray-800 scale-100";
                });
            };
        });

        document.getElementById('submit-review').onclick = () => {
            if(lastOrderRef) {
                update(ref(db, `orders/${lastOrderRef}`), { rating: selectedStars });
                localStorage.setItem('rated_'+lastOrderRef, 'true');
                document.getElementById('rating-modal').classList.add('hidden');
            }
        };

    </script>
</body>
</html>
