<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KHASM SHOP | Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø®ØµÙ…</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root{--gold:#f59e0b;--bg:#050505}body{font-family:'Cairo',sans-serif;background:var(--bg);color:white;min-height:100vh;margin:0}.carbon{position:fixed;inset:0;background-image:url('https://www.transparenttextures.com/patterns/carbon-fibre.png');opacity:.1;z-index:-1}.royal-card{background:rgba(20,20,20,.9);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.05);border-radius:24px;padding:20px;transition:.3s}.royal-card:hover{border-color:var(--gold);box-shadow:0 0 20px rgba(245,158,11,.1)}.khasm-btn{background:linear-gradient(135deg,#f59e0b,#92400e);color:black;font-weight:900;border-radius:12px;padding:14px;width:100%;transition:.2s}.khasm-btn:active{transform:scale(.96)}.page{display:none;animation:fadeIn .4s ease forwards}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}input,select{background:#111!important;border:1px solid #333!important;color:white!important;padding:12px;border-radius:12px;width:100%;outline:none;margin-bottom:10px}.nav-fixed{position:fixed;bottom:20px;left:20px;right:20px;height:70px;background:rgba(10,10,10,.95);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.1);border-radius:25px;display:flex;justify-content:space-around;align-items:center;z-index:1000}.nav-btn{color:#555;font-size:10px;font-weight:900;display:flex;flex-direction:column;align-items:center;gap:4px}.nav-btn.active{color:var(--gold)}.status-badge{font-size:9px;padding:2px 8px;border-radius:6px;font-weight:900}.tier-royal{color:#f59e0b;text-shadow:0 0 10px rgba(245,158,11,.6)}.tier-gold{color:#facc15}.tier-silver{color:#d1d5db}.tier-bronze{color:#fb923c}#royalToast{position:fixed;top:24px;right:16px;z-index:9999;display:none;padding:12px;border-radius:20px;background:rgba(20,20,20,.9);color:#f59e0b;text-align:center;animation:slideIn .4s ease,fadeOut .4s ease 3s forwards}@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}@keyframes fadeOut{to{opacity:0;transform:translateY(-10px)}}@keyframes royalPulse{0%{box-shadow:0 0 0 rgba(245,158,11,0)}50%{box-shadow:0 0 25px rgba(245,158,11,.15)}100%{box-shadow:0 0 0 rgba(245,158,11,0)}}.royal-pulse{animation:royalPulse 1.2s ease}
</style>
</head>
<body class="pb-32">
<div class="carbon"></div>

<!-- Login Overlay -->
<div id="loginOverlay" class="fixed inset-0 bg-black z-[9999] flex flex-col items-center justify-center p-6 text-center">
<h1 class="text-7xl font-black italic text-amber-500 mb-2">KHASM</h1>
<p class="text-gray-500 tracking-[10px] text-[10px] mb-12 uppercase font-bold">The Royal Shop</p>
<button id="loginBtn" class="bg-white text-black px-10 py-4 rounded-full font-black flex items-center gap-3 shadow-2xl">
<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20"> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©
</button>
</div>

<header class="p-5 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-50 border-b border-white/5">
<div>
<h2 class="text-xl font-black italic text-amber-500">KHASM SHOP</h2>
<p id="topUserName" class="text-[9px] text-gray-500 font-bold uppercase"></p>
<p id="userTier" class="text-[9px] font-black text-amber-400"></p>
</div>
<div class="flex items-center gap-2 bg-amber-500/10 px-3 py-1 rounded-xl border border-amber-500/20">
<span id="pointsDisplay" class="text-xl font-black text-amber-500">0</span>
<i class="fas fa-crown text-[10px] text-amber-500/50"></i>
</div>
</header>

<main class="p-4 max-w-2xl mx-auto">
<section id="page-shop" class="page active space-y-8">
<div class="royal-card bg-gradient-to-r from-amber-900/20 to-transparent">
<h3 class="text-lg font-black mb-1">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ”¥</h3>
<p class="text-[10px] text-gray-400">Ø§Ø®ØªØ± Ø¨Ø§Ù‚ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ ÙÙˆØ±Ø§Ù‹ Ù„Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯.</p>
</div>

<!-- Quick Order -->
<div id="quickOrderBox" class="hidden royal-card border-amber-500/30 mb-6">
<div class="flex justify-between items-center">
<div>
<p class="text-[10px] text-gray-400">Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù…ÙØ¶Ù„</p>
<b id="quickOrderText" class="text-sm"></b>
</div>
<button id="quickOrderBtn" class="khasm-btn w-auto px-6 py-2 text-xs">âš¡ Ø§Ø·Ù„Ø¨ ÙÙˆØ±Ù‹Ø§</button>
</div>
</div>

<div class="space-y-8">
<div>
<h3 class="text-sm font-black mb-4 flex items-center gap-2"><i class="fas fa-bolt text-amber-500"></i> Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
<div id="shop-direct" class="grid gap-4"></div>
</div>
<div>
<h3 class="text-sm font-black mb-4 flex items-center gap-2"><i class="fas fa-id-card text-amber-500"></i> Ø§Ù„Ø´Ø­Ù† Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ¯ÙŠ</h3>
<div id="shop-id" class="grid gap-4"></div>
</div>
<div>
<h3 class="text-sm font-black mb-4 flex items-center gap-2"><i class="fas fa-gem text-amber-500"></i> Ø§Ù„Ø­Ø²Ù… ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3>
<div id="shop-subs" class="grid gap-4"></div>
</div>
</div>
</section>

<section id="page-rewards" class="page text-center pt-10">
<div class="royal-card p-10 border-amber-500/20">
<i class="fas fa-gift text-6xl text-amber-500 mb-6"></i>
<h2 class="text-2xl font-black mb-10">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h2>
<div class="bg-black/50 p-6 rounded-[30px] border border-white/5 mb-8">
<p class="text-[10px] text-gray-500 mb-2">Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·</p>
<span id="pointsLarge" class="text-6xl font-black text-amber-500">0</span>
</div>
<input id="redeem-pid" type="number" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ø³ØªÙ„Ù…">
<button onclick="handleRedeem()" class="khasm-btn">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 30 Ù†Ù‚Ø·Ø© Ø¨Ù€ 60 UC âœ¨</button>
</div>
</section>

<section id="page-orders" class="page space-y-4">
<h3 class="text-lg font-black border-r-4 border-amber-500 pr-3">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒ</h3>
<div id="orders-list-user" class="space-y-4">
<p class="text-center text-gray-600 py-10 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„Ùƒ.</p>
</div>
</section>

<section id="page-admin" class="page space-y-8">
<div class="flex justify-between items-center border-b border-white/10 pb-4">
<h3 class="text-xl font-black text-amber-500">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
<span class="text-[10px] bg-red-600 px-2 py-1 rounded font-bold">Ù…ÙˆØ¸Ù</span>
</div>

<div class="space-y-4">
<h4 class="text-xs font-black text-gray-500 uppercase tracking-widest">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h4>
<div id="orders-list-admin" class="space-y-4"></div>
</div>

<div id="admin-tools" class="hidden pt-10 border-t border-white/10">
<h4 class="text-sm font-black mb-4 text-green-500">Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
<div class="royal-card space-y-2">
<select id="pkg-type">
<option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø±</option>
<option value="id">Ø´Ø­Ù† Ø¢ÙŠØ¯ÙŠ</option>
<option value="subs">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</option>
</select>
<input id="pkg-amount" type="text" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: 60 UC)">
<input id="pkg-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDG)">
<button onclick="addNewPackage()" class="khasm-btn">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØªØ¬Ø± â•</button>
</div>
<div id="pkg-manage-list" class="mt-6 space-y-2 opacity-30 text-[10px]"></div>

<!-- Backup Button -->
<button onclick="backupData()" class="khasm-btn text-xs w-full">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
</div>
</section>
</main>

<nav class="nav-fixed">
<button onclick="showPage('shop')" id="btn-shop" class="nav-btn active"><i class="fas fa-store text-xl"></i>Ø§Ù„Ù…ØªØ¬Ø±</button>
<button onclick="showPage('rewards')" id="btn-rewards" class="nav-btn"><i class="fas fa-crown text-xl"></i>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
<button onclick="showPage('orders')" id="btn-orders" class="nav-btn"><i class="fas fa-history text-xl"></i>Ø·Ù„Ø¨Ø§ØªÙŠ</button>
<button onclick="showPage('admin')" id="btn-admin" class="nav-btn hidden text-red-500"><i class="fas fa-user-shield text-xl"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
</nav>

<div id="ratingModal" class="fixed inset-0 bg-black/95 z-[10000] hidden flex items-center justify-center p-6">
<div class="royal-card w-full max-w-sm text-center">
<h3 class="text-xl font-black mb-8 text-amber-500">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
<div class="flex justify-center gap-4 text-4xl mb-10" id="star-rating">
<i class="fas fa-star text-gray-800" onclick="updateStars(1)"></i>
<i class="fas fa-star text-gray-800" onclick="updateStars(2)"></i>
<i class="fas fa-star text-gray-800" onclick="updateStars(3)"></i>
<i class="fas fa-star text-gray-800" onclick="updateStars(4)"></i>
<i class="fas fa-star text-gray-800" onclick="updateStars(5)"></i>
</div>
<button onclick="submitUserRating()" class="khasm-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
</div>
</div>

<div id="royalToast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const config={apiKey:"AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E",authDomain:"khasmshop.firebaseapp.com",databaseURL:"https://khasmshop-default-rtdb.firebaseio.com",projectId:"khasmshop"};
const app=initializeApp(config);
const db=getDatabase(app);
const auth=getAuth(app);
const provider=new GoogleAuthProvider();

const MASTER="mhmdfthu98@gmail.com";
const STAFF=["mohnadyasir43@gmail.com","muhammedaltaj111@gmail.com"];
let user=null,lastOrderCount=0,currentRatingKey="",selectedStars=5;

// Login
document.getElementById('loginBtn').onclick=()=>signInWithPopup(auth,provider);
window.logout=()=>signOut(auth).then(()=>location.reload());

// Pulse effect
function pulse(el){if(!el)return;el.classList.remove('royal-pulse');void el.offsetWidth;el.classList.add('royal-pulse');}
// Toast
function royalToast(msg){const t=document.getElementById('royalToast');t.innerText=msg;t.style.display='block';setTimeout(()=>t.style.display='none',3500);}

// Calculate Tier
function calculateTier(c){if(c>=30)return{name:"ğŸ‘‘ Ù…Ù„ÙƒÙŠ VIP",class:"tier-royal"};if(c>=15)return{name:"ğŸ¥‡ Ø°Ù‡Ø¨ÙŠ",class:"tier-gold"};if(c>=5)return{name:"ğŸ¥ˆ ÙØ¶ÙŠ",class:"tier-silver"};return{name:"ğŸ¥‰ Ø¨Ø±ÙˆÙ†Ø²ÙŠ",class:"tier-bronze"}}

// Show Page
window.showPage=id=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+id).classList.add('active');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn-'+id).classList.add('active');pulse(document.querySelector('.page.active'))}

// Add Package
window.addNewPackage=()=>{const t=document.getElementById('pkg-type').value,a=document.getElementById('pkg-amount').value,p=document.getElementById('pkg-price').value;if(a&&p)push(ref(db,'packages'),{type:t,amount:a,price:p})}

// Backup
window.backupData=()=>{get(ref(db)).then(snap=>{const dataStr=JSON.stringify(snap.val(),null,2);const blob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`khasm_backup_${Date.now()}.json`;a.click();URL.revokeObjectURL(url);alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!')})}

// Place Order
window.placeOrder=(amount,price,key,event)=>{const pid=document.getElementById('input-pid-'+key).value,agentSelect=document.getElementById('select-agent-'+key);if(!pid||pid.length<5)return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID ØµØ­ÙŠØ­");const agentName=agentSelect.options[agentSelect.selectedIndex].text,agentPhone=agentSelect.value;const newOrder={uid:user.uid,customer:user.displayName,amount:amount,price:price,pid:pid,agent:agentName,status:"â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",time:new Date().toLocaleString('ar-EG')};const btn=event?.target;if(btn)btn.disabled=true;setTimeout(()=>{if(btn)btn.disabled=false},3e3);push(ref(db,'orders'),newOrder).then(()=>{const msg=`ğŸ‘‘ *Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ Ù…Ù† KHASM SHOP*\n\nğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${user.displayName}\nğŸ’ *Ø§Ù„ÙƒÙ…ÙŠØ©:* ${amount}\nğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${price} SDG\nğŸ†” *Ø§Ù„Ø£ÙŠØ¯ÙŠ:* ${pid}\nğŸ›¡ï¸ *Ø§Ù„ÙˆÙƒÙŠÙ„:* ${agentName}`;window.open(`https://wa.me/${agentPhone}?text=${encodeURIComponent(msg)}`)});localStorage.setItem('last_order',JSON.stringify({amount,price,key}))}

// Change Status
window.changeStatus=(orderId,customerUid,amount,newStatus)=>{update(ref(db,`orders/${orderId}`),{status:newStatus});if(newStatus==="âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†"){get(ref(db,`users/${customerUid}/points`)).then(snap=>{const current=snap.val()||0;const pointsToAdd=parseInt(amount)>=60?Math.floor(parseInt(amount)/30):1;set(ref(db,`users/${customerUid}/points`),current+pointsToAdd)})}}

// Redeem
: "users/${user.uid}/points`),p-30});
    push(ref(db,'orders'),{
        uid: user.uid,
        customer: user.displayName,
        amount: "60 UC (Ø¬Ø§Ø¦Ø²Ø©)",
        price: "Ù†Ù‚Ø§Ø·",
        pid: pid,
        agent: "Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ",
        status: "ğŸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
        time: new Date().toLocaleString()
    });
    royalToast("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©! ğŸ‰");
} else alert("Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©");
});

// Update Stars
window.updateStars = n => {
    selectedStars = n;
    const stars = document.getElementById('star-rating').children;
    for(let i=0;i<5;i++)
        stars[i].className = i<n ? "fas fa-star text-amber-500" : "fas fa-star text-gray-800";
};

// Submit Rating
window.submitUserRating = () => {
    if(currentRatingKey){
        update(ref(db, `orders/${currentRatingKey}`), { rating: selectedStars });
        localStorage.setItem('rated_' + currentRatingKey, 'true');
        document.getElementById('ratingModal').classList.add('hidden');
        royalToast("ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…! â­");
        currentRatingKey = "";
    }
};

// Initialize App Engine
function initAppEngine(){
    // Fetch packages
    onValue(ref(db,'packages'), snap => {
        const lists = {
            direct: document.getElementById('shop-direct'),
            id: document.getElementById('shop-id'),
            subs: document.getElementById('shop-subs')
        };
        const manage = document.getElementById('pkg-manage-list');
        Object.values(lists).forEach(l=>l.innerHTML=''); manage.innerHTML='';

        snap.forEach(child => {
            const d = child.val(), k = child.key;
            const itemHtml = `
            <div class="royal-card">
                <div class="flex justify-between mb-4">
                    <div><h4 class="text-xl font-black">${d.amount}</h4><p class="text-amber-500 font-bold">${d.price} SDG</p></div>
                </div>
                <select id="select-agent-${k}" class="text-[10px] font-bold">
                    <option value="249907760989">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø¬Ù…ÙˆØ¯</option>
                    <option value="249914178935">ğŸ›¡ï¸ Ù…Ù‡Ù†Ø¯ ÙŠØ§Ø³Ø±</option>
                    <option value="0916581517">ğŸ›¡ï¸ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ§Ø¬ Ø­Ù…Ø²Ø©</option>
                </select>
                <input id="input-pid-${k}" type="number" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="text-center font-black">
                <button onclick="placeOrder('${d.amount}','${d.price}','${k}')" class="khasm-btn">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€</button>
            </div>`;
            if(lists[d.type]) lists[d.type].innerHTML += itemHtml;
            manage.innerHTML += `<div class="flex justify-between border-b border-white/5 py-1">
                <span>${d.amount}</span>
                <button onclick="remove(ref(db,'packages/${k}'))" class="text-red-500">Ø­Ø°Ù</button>
            </div>`;
        });
    });

    // Fetch Orders
    onValue(ref(db,'orders'), snap => {
        const userList = document.getElementById('orders-list-user');
        const adminList = document.getElementById('orders-list-admin');
        userList.innerHTML=''; adminList.innerHTML='';

        // New order notification
        if(snap.numChildren() > lastOrderCount && lastOrderCount!==0){
            if(user.email.toLowerCase()===MASTER || STAFF.includes(user.email.toLowerCase())){
                new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play();
            }
        }
        lastOrderCount = snap.numChildren();

        snap.forEach(child => {
            const v = child.val(), k = child.key;

            // User view
            if(v.uid === user.uid){
                const sColor = v.status.includes('ØªÙ…') ? 'bg-green-600' : 'bg-amber-600';
                userList.innerHTML += `
                <div class="royal-card flex justify-between items-center border-r-4 ${v.status.includes('ØªÙ…')?'border-green-600':'border-amber-600'}">
                    <div><b class="text-lg">${v.amount}</b><br><span class="status-badge ${sColor}">${v.status}</span></div>
                    <div class="text-right"><p class="text-[10px] text-gray-500">${v.time}</p>
                    <p class="text-xs font-black text-amber-500">${v.rating ? 'â­ '+v.rating : 'ID: '+v.pid}</p></div>
                </div>`;

                if(v.status==="âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†" && !v.rating && !localStorage.getItem('rated_'+k)){
                    currentRatingKey = k;
                    document.getElementById('ratingModal').classList.remove('hidden');
                }
            }

            // Admin view
            if(user.email.toLowerCase()===MASTER || STAFF.includes(user.email.toLowerCase())){
                adminList.innerHTML += `
                <div class="royal-card border-l-4 border-amber-600">
                    <div class="flex justify-between mb-2"><b>ğŸ‘¤ ${v.customer}</b>
                    <button onclick="remove(ref(db,'orders/${k}'))" class="text-red-500 opacity-20"><i class="fas fa-trash"></i></button></div>
                    <p class="text-xs font-black text-gray-400">${v.amount} | ID: ${v.pid}</p>
                    <p class="text-[8px] text-amber-500 mb-4">Ø§Ù„ÙˆÙƒÙŠÙ„: ${v.agent} ${v.rating ? '| â­ '+v.rating : ''}</p>
                    <div class="flex gap-2">
                        <button onclick="changeStatus('${k}','${v.uid}','${v.amount}','âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†')" class="flex-1 bg-green-600 text-[10px] py-2 rounded-lg font-black text-white">Ø¥ØªÙ…Ø§Ù…</button>
                        <button onclick="changeStatus('${k}','${v.uid}','${v.amount}','â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°')" class="flex-1 bg-blue-600 text-[10px] py-2 rounded-lg font-black text-white">ØªÙ†ÙÙŠØ°</button>
                        <button onclick="changeStatus('${k}','${v.uid}','${v.amount}','âŒ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨')" class="flex-1 bg-red-600 text-[10px] py-2 rounded-lg font-black text-white">ÙØ´Ù„</button>
                    </div>
                </div>`;
            }
        });
    });

    // Fetch Points
    onValue(ref(db,`users/${user.uid}/points`), snap=>{
        const val = snap.val()||0;
        document.getElementById('pointsDisplay').innerText = val;
        document.getElementById('pointsLarge').innerText = val;

        // Update Tier
        const tier = calculateTier(val);
        const tierEl = document.getElementById('userTier');
        if(tierEl) { tierEl.innerText = tier.name; tierEl.className = tier.class; }
    });

}

// Initialize after login
onAuthStateChanged(auth, u => {
    if(u){
        user = u;
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('topUserName').innerText = u.displayName;

        const email = u.email.toLowerCase();
        if(email===MASTER || STAFF.includes(email)){
            document.getElementById('btn-admin').classList.remove('hidden');
            if(email===MASTER) document.getElementById('admin-tools').classList.remove('hidden');
        }

        initAppEngine();

        // Quick Order setup
        const lastOrder = JSON.parse(localStorage.getItem('last_order')||'{}');
        if(lastOrder.amount && lastOrder.price){
            document.getElementById('quickOrderBox').classList.remove('hidden');
            document.getElementById('quickOrderText').innerText = `${lastOrder.amount} - ${lastOrder.price} SDG`;
            document.getElementById('quickOrderBtn').onclick = ()=>placeOrder(lastOrder.amount,lastOrder.price,lastOrder.key);
        }
    }
});
window.handleRedeem=()=>{const pid=document.getElementById('redeem-pid').value;if(!pid)return alert("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ø³ØªÙ„Ù…");get(ref(db,`users/${user.uid}/points`)).then(s=>{const p=s.val()||0;if(p>=30){set(ref(db,`users/${user.uid}/points`),p-30);push(ref(db,'orders'),{uid
