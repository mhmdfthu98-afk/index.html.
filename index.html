<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø®ØµÙ… | KHASM SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #050505; color: #ffffff; }
        .royal-card { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; transition: 0.4s; }
        .royal-card:hover { border-color: #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.2); }
        .gold-text { background: linear-gradient(to right, #f59e0b, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .khasm-btn { background: linear-gradient(135deg, #16a34a 0%, #065f46 100%); transition: 0.3s; position: relative; overflow: hidden; }
        .khasm-btn:active { transform: scale(0.95); }
        .page { display: none; animation: slideUp 0.5s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        input, select { background: #111 !important; border: 1px solid #333 !important; color: white !important; padding: 12px; border-radius: 12px; width: 100%; outline: none; }
        .nav-item { transition: 0.3s; opacity: 0.6; }
        .nav-item.active { opacity: 1; color: #22c55e; transform: translateY(-3px); }
    </style>
</head>
<body class="pb-24">

    <div id="loginOverlay" class="fixed inset-0 bg-black z-[9999] flex flex-col items-center justify-center p-8">
        <div class="text-center mb-12">
            <h1 class="text-8xl font-black italic text-green-500 tracking-tighter">KHASM</h1>
            <p class="text-amber-500 font-bold tracking-[5px] text-sm mt-2">PREMIUM GAMING SHOP</p>
        </div>
        <button id="loginBtn" class="bg-white text-black px-10 py-4 rounded-full font-black flex items-center gap-3 shadow-2xl hover:bg-gray-200 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20">
            Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±
        </button>
    </div>

    <header class="p-5 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-50 border-b border-white/5">
        <div>
            <h2 class="text-xl font-black italic text-green-500">KHASM SHOP</h2>
            <p id="userNameDisplay" class="text-[10px] text-gray-400 font-bold"></p>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right">
                <span id="starsCount" class="text-xl font-black text-amber-500 block leading-none">0</span>
                <span class="text-[8px] font-bold text-gray-500 uppercase">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙƒÙŠØ©</span>
            </div>
            <button onclick="logout()" class="text-red-500 text-sm"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="p-4 max-w-2xl mx-auto">
        <div class="mb-8">
            <div class="royal-card p-6 bg-gradient-to-br from-green-900/20 to-transparent">
                <span class="bg-green-500 text-black text-[10px] font-black px-2 py-1 rounded-md mb-2 inline-block">Ø¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ© ğŸ”¥</span>
                <h3 class="text-2xl font-black mb-1">Ø®ØµÙ… 5% Ø¹Ù„Ù‰ ÙƒØ§ÙØ© Ø§Ù„Ø´Ø­Ù†Ø§Øª</h3>
                <p class="text-gray-400 text-xs">Ø§Ø¬Ù…Ø¹ 30 Ù†Ù‚Ø·Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù€ 60 UC Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙÙˆØ±Ø§Ù‹!</p>
            </div>
        </div>

        <section id="page-shop" class="page active space-y-12">
            <div>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fas fa-bolt text-green-500"></i> Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                <div id="list-direct" class="grid grid-cols-1 gap-4"></div>
            </div>
            <div>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fas fa-id-card text-amber-500"></i> Ø§Ù„Ø´Ø­Ù† Ø¹Ø¨Ø± Ø§Ù„Ø¢ÙŠØ¯ÙŠ (Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ©)</h3>
                <div id="list-id" class="grid grid-cols-1 gap-4"></div>
            </div>
            <div>
                <h3 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fas fa-gem text-blue-500"></i> Ø§Ù„Ø­Ø²Ù… ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
                <div id="list-subs" class="grid grid-cols-1 gap-4"></div>
            </div>
        </section>

        <section id="page-rewards" class="page">
            <div class="royal-card p-10 text-center">
                <i class="fas fa-crown text-6xl text-amber-500 mb-6"></i>
                <h2 class="text-3xl font-black mb-2">Ù‚ØµØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h2>
                <p class="text-gray-400 text-sm mb-8">ÙƒÙ„ 30 Ù†Ù‚Ø·Ø© ØªÙ…Ù†Ø­Ùƒ 60 UC Ù‡Ø¯ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©</p>
                <div class="bg-white/5 p-6 rounded-3xl mb-8">
                    <p class="text-xs text-gray-500 mb-2 font-bold uppercase">Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                    <span id="pointsLarge" class="text-6xl font-black text-amber-500">0</span>
                </div>
                <input id="pid-redeem" type="number" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="text-center mb-4">
                <button onclick="redeemPoints()" class="khasm-btn w-full py-4 rounded-2xl font-black text-lg">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¢Ù† âœ¨</button>
            </div>
        </section>

        <section id="page-orders" class="page space-y-4">
            <h3 class="text-lg font-black border-r-4 border-green-500 pr-3">Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§ØªÙƒ</h3>
            <div id="user-orders" class="space-y-4"></div>
        </section>

        <section id="page-admin" class="page space-y-8">
            <div class="border-b border-white/10 pb-4">
                <h3 class="text-2xl font-black text-amber-500 italic">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ø§Ø¯Ø©</h3>
            </div>
            
            <div id="adm-orders-view" class="space-y-4"></div>

            <div id="admin-products-section" class="hidden space-y-6 pt-6 border-t border-white/10">
                <h3 class="text-xl font-black text-green-500">Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù… Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <div class="royal-card p-6 space-y-4">
                    <select id="add-type">
                        <option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø±</option>
                        <option value="id">Ø´Ø­Ù† Ø¢ÙŠØ¯ÙŠ</option>
                        <option value="subs">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ­Ø²Ù…</option>
                    </select>
                    <input id="add-a" type="text" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: 660 UC)">
                    <input id="add-p" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDG)">
                    <button onclick="pushNewPkg()" class="khasm-btn w-full py-3 rounded-xl font-black">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØªØ¬Ø±</button>
                </div>
                <div id="adm-pkgs-list" class="space-y-2"></div>
            </div>
        </section>
    </main>

    <div id="ratingPopup" class="fixed inset-0 bg-black/95 z-[10000] hidden flex items-center justify-center p-6">
        <div class="royal-card p-8 w-full max-w-sm text-center">
            <h3 class="text-2xl font-black mb-2 text-amber-500">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h3>
            <p class="text-xs text-gray-400 mb-8">Ø±Ø£ÙŠÙƒ ÙŠÙ‡Ù…Ù†Ø§ ÙŠØ§ Ø¨Ø·Ù„ØŒ ÙƒÙŠÙ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ØŸ</p>
            <div class="flex justify-center gap-4 text-4xl mb-10" id="stars-input">
                <i class="fas fa-star text-gray-800 cursor-pointer" onclick="setStar(1)"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" onclick="setStar(2)"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" onclick="setStar(3)"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" onclick="setStar(4)"></i>
                <i class="fas fa-star text-gray-800 cursor-pointer" onclick="setStar(5)"></i>
            </div>
            <button onclick="submitRating()" class="khasm-btn w-full py-3 rounded-xl font-black">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ğŸ‘‘</button>
        </div>
    </div>

    <nav class="fixed bottom-0 inset-x-0 h-20 bg-black border-t border-white/5 flex justify-around items-center z-50 px-4">
        <button onclick="changePage('shop')" id="n-shop" class="nav-item active flex flex-col items-center gap-1 text-[10px] font-black"><i class="fas fa-store text-xl"></i>Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button onclick="changePage('rewards')" id="n-rewards" class="nav-item flex flex-col items-center gap-1 text-[10px] font-black"><i class="fas fa-gift text-xl"></i>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
        <button onclick="changePage('orders')" id="n-orders" class="nav-item flex flex-col items-center gap-1 text-[10px] font-black"><i class="fas fa-list-ul text-xl"></i>Ø·Ù„Ø¨Ø§ØªÙŠ</button>
        <button id="n-admin" onclick="changePage('admin')" class="nav-item hidden flex flex-col items-center gap-1 text-[10px] font-black text-red-500"><i class="fas fa-user-shield text-xl"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = { apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", authDomain: "khasmshop.firebaseapp.com", databaseURL: "https://khasmshop-default-rtdb.firebaseio.com", projectId: "khasmshop" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†
        const MASTER_ADMIN = "mhmdfthu98@gmail.com";
        const AGENTS = ["mohnadyasir43@gmail.com", "muhammedaltaj111@gmail.com"];
        
        let user = null;
        let lastOrderCount = 0;
        let selectedStars = 5;
        let currentOrderForRating = "";

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('userNameDisplay').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${u.displayName}`;
                
                const email = u.email.toLowerCase();
                if (email === MASTER_ADMIN || AGENTS.includes(email)) {
                    document.getElementById('n-admin').classList.remove('hidden');
                    if (email === MASTER_ADMIN) document.getElementById('admin-products-section').classList.remove('hidden');
                }
                initSync();
            }
        });

        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        window.changePage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('n-' + id).classList.add('active');
        };

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        window.pushNewPkg = () => {
            const type = document.getElementById('add-type').value;
            const amount = document.getElementById('add-a').value;
            const price = document.getElementById('add-p').value;
            if (amount && price) {
                push(ref(db, 'packages'), { type, amount, price });
                document.getElementById('add-a').value = '';
                document.getElementById('add-p').value = '';
            }
        };

        window.deletePkg = (key) => confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ") && remove(ref(db, `packages/${key}`));
        window.deleteOrder = (key) => confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ØŸ") && remove(ref(db, `orders/${key}`));

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        window.updateStatus = (key, uid, amount, status) => {
            update(ref(db, `orders/${key}`), { status: status });
            if (status === 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†') {
                const pointsRef = ref(db, `users/${uid}/stars`);
                get(pointsRef).then(snap => {
                    const currentPoints = snap.val() || 0;
                    const gain = parseInt(amount) >= 60 ? Math.floor(parseInt(amount)/30) : 1;
                    set(pointsRef, currentPoints + gain);
                });
            }
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨
        window.sendOrder = (amt, price, key) => {
            const pid = document.getElementById('pid-' + key).value;
            const agentSelect = document.getElementById('agent-' + key);
            if (!pid || pid.length < 5) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!");
            
            const agentName = agentSelect.options[agentSelect.selectedIndex].text;
            const agentPhone = agentSelect.value;

            const orderData = {
                userName: user.displayName,
                userId: user.uid,
                amount: amt,
                price: price,
                pid: pid,
                agent: agentName,
                status: 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                date: new Date().toLocaleString('ar-EG')
            };

            push(ref(db, 'orders'), orderData).then(() => {
                const msg = `ğŸ‘‘ *Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ Ù…Ù† KHASM SHOP*\n\nğŸ‘¤ *Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${user.displayName}\nğŸ’ *Ø§Ù„Ù…Ù†ØªØ¬:* ${amt}\nğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${price} SDG\nğŸ†” *Ø§Ù„Ø¢ÙŠØ¯ÙŠ:* ${pid}\nğŸ›¡ï¸ *Ø§Ù„ÙˆÙƒÙŠÙ„:* ${agentName}\n\nâœ… ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù† Ù„ÙŠØªÙ… Ø§Ù„Ø´Ø­Ù† ÙÙˆØ±Ø§Ù‹.`;
                window.open(`https://wa.me/${agentPhone}?text=${encodeURIComponent(msg)}`);
            });
        };

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        window.setStar = (n) => {
            selectedStars = n;
            const stars = document.getElementById('stars-input').children;
            for(let i=0; i<5; i++) {
                stars[i].className = i < n ? "fas fa-star text-amber-500 cursor-pointer" : "fas fa-star text-gray-800 cursor-pointer";
            }
        };

        window.submitRating = () => {
            if(currentOrderForRating) {
                update(ref(db, `orders/${currentOrderForRating}`), { rating: selectedStars });
                document.getElementById('ratingPopup').classList.add('hidden');
            }
        };

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·
        window.redeemPoints = () => {
            const pid = document.getElementById('pid-redeem').value;
            if(!pid) return alert("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ„Ù…!");
            const pRef = ref(db, `users/${user.uid}/stars`);
            get(pRef).then(snap => {
                const pts = snap.val() || 0;
                if(pts >= 30) {
                    set(pRef, pts - 30);
                    push(ref(db, 'orders'), {
                        userName: user.displayName,
                        userId: user.uid,
                        amount: "60 UC (Ø¬Ø§Ø¦Ø²Ø©)",
                        price: "Ù†Ù‚Ø§Ø·",
                        pid: pid,
                        agent: "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠ",
                        status: 'ğŸ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‡Ø¯ÙŠØ©',
                        date: new Date().toLocaleString('ar-EG')
                    });
                    alert("ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.");
                } else {
                    alert("Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©ØŒ ØªØ­ØªØ§Ø¬ Ù„Ù€ 30 Ù†Ù‚Ø·Ø©.");
                }
            });
        };

        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ©
        function initSync() {
            // 1. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            onValue(ref(db, 'packages'), snap => {
                const lists = { direct: document.getElementById('list-direct'), id: document.getElementById('list-id'), subs: document.getElementById('list-subs') };
                const admList = document.getElementById('adm-pkgs-list');
                Object.values(lists).forEach(l => l.innerHTML = ''); admList.innerHTML = '';

                snap.forEach(child => {
                    const d = child.val(), k = child.key;
                    const itemHtml = `
                    <div class="royal-card p-5">
                        <div class="flex justify-between items-center mb-4">
                            <div><h4 class="text-2xl font-black">${d.amount}</h4><p class="text-amber-500 font-bold">${d.price} SDG</p></div>
                            <i class="fas fa-bolt text-green-500/20 text-3xl"></i>
                        </div>
                        <select id="agent-${k}" class="mb-3 text-xs font-bold">
                            <option value="249907760989">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ØªØ¬Ø±</option>
                            <option value="249914178935">ğŸ›¡ï¸ Ù…Ù‡Ù†Ø¯ ÙŠØ§Ø³Ø± Ø¨Ù„ÙˆÙ„Ù‡</option>
                            <option value="201550165993">ğŸ‡ªğŸ‡¬ Ù…Ø­Ù…Ø¯ ÙØªØ­ÙŠ Ø­Ù…Ø²Ù‡</option>
                        </select>
                        <input id="pid-${k}" type="number" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨" class="mb-4 text-center font-black">
                        <button onclick="sendOrder('${d.amount}','${d.price}','${k}')" class="khasm-btn w-full py-3 rounded-xl font-black shadow-lg">Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¢Ù† ğŸš€</button>
                    </div>`;
                    if (lists[d.type]) lists[d.type].innerHTML += itemHtml;
                    if (user.email.toLowerCase() === MASTER_ADMIN) {
                        admList.innerHTML += `<div class="flex justify-between bg-white/5 p-3 rounded-lg text-xs"><span>${d.amount} (${d.type})</span><button onclick="deletePkg('${k}')" class="text-red-500 font-bold">Ø­Ø°Ù</button></div>`;
                    }
                });
            });

            // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            onValue(ref(db, 'orders'), snap => {
                const userView = document.getElementById('user-orders');
                const adminView = document.getElementById('adm-orders-view');
                userView.innerHTML = ''; adminView.innerHTML = '';
                
                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                if (snap.numChildren() > lastOrderCount && lastOrderCount !== 0) {
                    if (user.email.toLowerCase() === MASTER_ADMIN || AGENTS.includes(user.email.toLowerCase())) {
                        new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play();
                    }
                }
                lastOrderCount = snap.numChildren();

                snap.forEach(child => {
                    const v = child.val(), k = child.key;
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨ÙˆÙ†
                    if (v.userId === user.uid) {
                        userView.innerHTML += `
                        <div class="royal-card p-4 border-r-4 ${v.status.includes('ØªÙ…') ? 'border-green-500' : 'border-amber-500'} flex justify-between items-center">
                            <div><b class="text-lg">${v.amount}</b><br><span class="text-[10px] font-bold uppercase opacity-60">${v.status}</span></div>
                            <div class="text-left font-bold text-xs ${v.rating ? 'text-amber-500' : 'text-gray-600'}">${v.rating ? 'â­ ØªÙ‚ÙŠÙŠÙ…Ùƒ: '+v.rating : 'ID: '+v.pid}</div>
                        </div>`;
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                        if (v.status === 'âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†' && !v.rating && !localStorage.getItem('rated_'+k)) {
                            currentOrderForRating = k;
                            document.getElementById('ratingPopup').classList.remove('hidden');
                            localStorage.setItem('rated_'+k, 'true');
                        }
                    }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                    if (user.email.toLowerCase() === MASTER_ADMIN || AGENTS.includes(user.email.toLowerCase())) {

                     adminView.innerHTML += `
                        <div class="royal-card p-4 border-l-4 border-green-500 relative">
                            <div class="flex justify-between items-start mb-2">
                                <b>ğŸ‘¤ ${v.userName}</b>
                                <button onclick="deleteOrder('${k}')" class="text-red-500 opacity-30 hover:opacity-100"><i class="fas fa-trash"></i></button>
                            </div>
                            <p class="text-sm font-black">${v.amount} | ID: ${v.pid}</p>
                            <p class="text-[10px] text-amber-500 font-bold mb-4">Ù…ÙˆØ¬Ù‡ Ù„Ù€: ${v.agent} ${v.rating ? '| â­ ØªÙ‚ÙŠÙŠÙ…: '+v.rating : ''}</p>
                            <div class="flex gap-2">
                                <button onclick="updateStatus('${k}','${v.userId}','${v.amount}','âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†')" class="flex-1 bg-green-600 py-2 rounded-lg text-[10px] font-black">Ø¥ØªÙ…Ø§Ù…</button>
                                <button onclick="updateStatus('${k}','${v.userId}','${v.amount}','â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°')" class="flex-1 bg-blue-600 py-2 rounded-lg text-[10px] font-black">ØªÙ†ÙÙŠØ°</button>
                                <button onclick="updateStatus('${k}','${v.userId}','${v.amount}','âŒ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨')" class="flex-1 bg-red-600 py-2 rounded-lg text-[10px] font-black">ÙØ´Ù„</button>
                            </div>
                        </div>`;
                    }
                });
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
            onValue(ref(db, `users/${user.uid}/stars`), s => {
                const val = s.val() || 0;
                document.getElementById('starsCount').innerText = val;
                document.getElementById('pointsLarge').innerText = val;
            });
        }
    </script>
</body>
</html>
