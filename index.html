<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhasmShop | المتجر الكامل V10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; }
        .admin-section { border-top: 10px solid #ef4444; border-radius: 40px; }
        .glass-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50">

<div id="loader" class="fixed inset-0 z-[9999] bg-slate-900 flex flex-col items-center justify-center">
    <div class="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="text-white mt-4 font-black text-xs italic tracking-widest">KHASM SHOP V10</p>
</div>

<div id="auth-screen" class="hidden fixed inset-0 z-[8888] bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
    <h1 class="text-5xl font-black text-yellow-500 italic mb-10 tracking-tighter">KHASM SHOP</h1>
    <button id="loginBtn" class="bg-white text-slate-900 px-10 py-5 rounded-[30px] font-black shadow-2xl flex items-center gap-3 text-lg">
        <img src="https://www.google.com/favicon.ico" class="w-6"> دخول عبر جوجل
    </button>
</div>

<div id="app" class="hidden min-h-screen pb-20">
    <header class="glass-nav text-white p-6 rounded-b-[50px] shadow-2xl mb-8">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="userImg" src="" class="w-12 h-12 rounded-2xl border-2 border-yellow-500">
                <div>
                    <h2 id="userName" class="text-sm font-black italic tracking-tighter">...</h2>
                    <p id="userBalance" class="text-yellow-500 text-xs font-bold">رصيدك: 0 ج.س</p>
                </div>
            </div>
            <button onclick="logout()" class="text-red-400 p-2"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4">
        
        <div id="adminPanel" class="hidden space-y-6 mb-12">
            <div class="bg-white p-8 admin-section shadow-2xl">
                <h3 class="text-center font-black text-red-600 mb-8 italic underline uppercase">إدارة المتجر والمخزن</h3>

                <div class="bg-slate-50 p-5 rounded-[30px] border mb-6">
                    <p class="text-[10px] font-black text-slate-400 mb-4 italic uppercase">/ خطوة 1: تعريف باقة جديدة</p>
                    <input id="newPName" type="text" placeholder="مثلاً: 60 شدة" class="w-full p-4 rounded-2xl text-xs border mb-3 outline-none font-bold">
                    <input id="newPPrice" type="number" placeholder="سعر البيع ج.س" class="w-full p-4 rounded-2xl text-xs border mb-3 outline-none font-bold">
                    <button onclick="saveProduct()" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-xs font-black shadow-lg uppercase italic">حفظ الباقة في المتجر</button>
                </div>

                <div class="bg-green-50 p-5 rounded-[30px] border border-green-200">
                    <p class="text-[10px] font-black text-green-600 mb-4 italic uppercase">/ خطوة 2: تعبئة مخزن الأكواد</p>
                    <select id="targetPSelect" class="w-full p-4 rounded-2xl text-xs border mb-3 outline-none font-bold bg-white italic">
                        <option value="">-- اختر الباقة من هنا --</option>
                    </select>
                    <textarea id="bulkCodesInput" placeholder="الصق الأكواد هنا (كود في كل سطر)" class="w-full p-4 rounded-2xl text-xs border outline-none h-28 mb-4 font-mono"></textarea>
                    <button onclick="saveCodes()" class="w-full bg-green-600 text-white py-4 rounded-2xl text-xs font-black shadow-lg uppercase italic">تحديث الكمية ✅</button>
                </div>
            </div>
        </div>

        <section>
            <h3 class="font-black text-slate-800 mb-6 border-r-4 border-yellow-500 pr-3 italic uppercase text-sm">عروض شحن ببجي المتاحة</h3>
            <div id="productsGrid" class="grid grid-cols-2 gap-4">
                </div>
        </section>

    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // إعدادات Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E", 
        authDomain: "khasmshop.firebaseapp.com", 
        projectId: "khasmshop", 
        storageBucket: "khasmshop.firebasestorage.app", 
        messagingSenderId: "238182001615", 
        appId: "1:238182001615:web:d77391030a40a481b440ba" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const MY_EMAIL = "mhmdfthu98@gmail.com"; // إيميلك المسجل لإظهار لوحة التحكم

    // التحقق من الدخول
    onAuthStateChanged(auth, async (user) => {
        document.getElementById('loader').classList.add('hidden');
        if (user) {
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('userImg').src = user.photoURL;
            
            if (user.email === MY_EMAIL) {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
            loadData();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
    });

    // تسجيل الدخول والخروج
    document.getElementById('loginBtn').onclick = () => signInWithRedirect(auth, provider);
    window.logout = () => signOut(auth).then(() => location.reload());

    // تحميل وعرض البيانات
    function loadData() {
        onSnapshot(collection(db, "products"), async (snap) => {
            const grid = document.getElementById('productsGrid');
            const select = document.getElementById('targetPSelect');
            grid.innerHTML = ''; 
            select.innerHTML = '<option value="">-- اختر الباقة من هنا --</option>';

            for (const d of snap.docs) {
                const p = d.data();
                const pID = d.id;

                // إضافة الباقة للقائمة المنسدلة
                const opt = document.createElement('option');
                opt.value = pID;
                opt.textContent = p.name;
                select.appendChild(opt);

                // حساب عدد الأكواد المتوفرة
                const q = query(collection(db, "codes_stock"), where("productID", "==", pID), where("status", "==", "available"));
                const codesSnap = await getDocs(q);
                const count = codesSnap.size;

                // عرض بطاقة المنتج
                grid.innerHTML += `
                    <div class="bg-white p-5 rounded-[40px] shadow-sm border border-white text-center">
                        <p class="font-black text-[11px] text-slate-800 italic mb-1 uppercase">${p.name}</p>
                        <p class="text-blue-600 font-black text-xs mb-3 italic">${p.price} ج.س</p>
                        <div class="mb-4">
                            <span class="text-[9px] font-black px-3 py-1 rounded-full ${count > 0 ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} italic">
                                ${count > 0 ? 'متوفر: ' + count : 'نفذت الكمية'}
                            </span>
                        </div>
                        <button class="w-full ${count > 0 ? 'bg-slate-900 shadow-lg shadow-slate-200' : 'bg-slate-200'} text-white text-[10px] py-3.5 rounded-2xl font-black italic">
                            ${count > 0 ? 'شراء الآن' : 'غير متوفر'}
                        </button>
                    </div>
                `;
            }
        });
    }

    // وظائف الإدارة
    window.saveProduct = async () => {
        const name = document.getElementById('newPName').value;
        const price = document.getElementById('newPPrice').value;
        if (!name || !price) return alert("أدخل بيانات الباقة!");
        
        await addDoc(collection(db, "products"), { name, price: parseInt(price) });
        alert("تم حفظ الباقة بنجاح!");
        document.getElementById('newPName').value = '';
        document.getElementById('newPPrice').value = '';
    };

    window.saveCodes = async () => {
        const pID = document.getElementById('targetPSelect').value;
        const text = document.getElementById('bulkCodesInput').value.trim();
        if (!pID || !text) return alert("اختر الباقة وضع الأكواد!");

        const codes = text.split('\n');
        for (let c of codes) {
            if (c.trim()) {
                await addDoc(collection(db, "codes_stock"), {
                    productID: pID,
                    code: c.trim(),
                    status: "available"
                });
            }
        }
        alert("تم تحديث المخزن!");
        document.getElementById('bulkCodesInput').value = '';
    };

</script>
</body>
    </html>
