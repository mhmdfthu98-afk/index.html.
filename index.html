<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhasmShop | ุงููุชุฌุฑ ุงููุชูุงูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .sidebar { transition: 0.3s; }
        .product-card { transition: 0.3s; border: 1px solid #f0f0f0; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="sidebar" class="fixed top-0 right-0 h-full w-64 bg-blue-900 text-white z-50 transform translate-x-full sidebar p-5 shadow-2xl">
        <button onclick="toggleSidebar()" class="text-white mb-8 text-2xl"><i class="fas fa-times"></i></button>
        <div class="mb-8 text-center border-b border-blue-800 pb-4">
            <p class="text-blue-300 text-xs">ุฑูู ุญุณุงุจ ุงููุญูุธุฉ</p>
            <p id="sideWalletID" class="text-xl font-black text-yellow-400 tracking-widest">------</p>
        </div>
        <nav class="space-y-4">
            <a href="#" class="block py-2 px-4 hover:bg-blue-800 rounded-xl"><i class="fas fa-home ml-2"></i> ุงูุฑุฆูุณุฉ</a>
            <a href="#" class="block py-2 px-4 hover:bg-blue-800 rounded-xl"><i class="fas fa-shopping-cart ml-2"></i> ุทูุจุงุชู</a>
            <a href="#" class="block py-2 px-4 hover:bg-blue-800 rounded-xl"><i class="fas fa-star ml-2"></i> ุชูููู ุงููููุงุก</a>
            <button onclick="logout()" class="w-full text-right py-2 px-4 text-red-400 hover:bg-blue-800 rounded-xl"><i class="fas fa-sign-out-alt ml-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </nav>
    </div>

    <div class="max-w-md mx-auto min-h-screen relative pb-10">
        <header class="flex justify-between items-center p-4 bg-white shadow-sm sticky top-0 z-40">
            <button onclick="toggleSidebar()" class="text-2xl text-blue-900"><i class="fas fa-bars"></i></button>
            <h1 class="text-xl font-black text-blue-900">KHASM SHOP</h1>
            <div id="rankBadge" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-[10px] font-bold">ุชุญููู...</div>
        </header>

        <div class="bg-gradient-to-r from-blue-700 to-blue-500 text-white py-1 shadow-inner overflow-hidden">
            <div class="whitespace-nowrap animate-marquee px-4 font-bold text-xs">
                ๐ฅ ุฎุตููุงุช ุชุตู ูู 12% ููุฑุชุจ ุงููุงุณูุฉ! | ุดุญู ููุฑู ูุขูู | ูุฑุญุจุงู ุจู ูู ุฎุถู ุดูุจ ๐ฅ
            </div>
        </div>

        <div class="p-4">
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-gray-400">ุฑุตูุฏ ุงููุญูุธุฉ</p>
                        <div class="flex items-baseline gap-1">
                            <span id="balance" class="text-3xl font-black">0.00</span>
                            <span class="text-blue-600 font-bold text-xs text-sm">SDG</span>
                        </div>
                    </div>
                    <div class="text-left">
                        <p class="text-xs text-gray-400">ุฅุฌูุงูู ุงูุดุฏุงุช</p>
                        <p id="totalUC" class="font-bold text-blue-600">0 ุดุฏุฉ</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-[10px] mb-1">
                        <span id="nextRankText">ุงูุฑุชุจุฉ ุงููุงุฏูุฉ: ูุถู</span>
                        <span id="progressText">0/900</span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full w-0 transition-all"></div>
                    </div>
                </div>
            </div>

            <div id="adminPanel" class="hidden bg-gray-900 rounded-3xl p-6 mb-8 text-white">
                <h3 class="text-yellow-400 font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-user-shield"></i> ููุญุฉ ุดุญู ุงููุญุงูุธ
                </h3>
                <input id="targetWalletID" type="text" maxlength="6" placeholder="ุฑูู ูุญูุธุฉ ุงูุฒุจูู (6 ุฃุฑูุงู)" class="w-full mb-3 p-3 rounded-xl bg-gray-800 text-white border-none text-center font-bold outline-none ring-1 ring-gray-700 focus:ring-yellow-400">
                <input id="chargeAmount" type="number" placeholder="ุงููุจูุบ ุงููุฑุงุฏ ุฅูุฏุงุนู" class="w-full mb-4 p-3 rounded-xl bg-gray-800 text-white border-none text-center font-bold outline-none ring-1 ring-gray-700 focus:ring-yellow-400">
                <button onclick="confirmCharge()" class="w-full bg-yellow-400 text-black font-black py-4 rounded-xl hover:bg-yellow-300 transition-all active:scale-95">ุชุฃููุฏ ุนูููุฉ ุงูุฅูุฏุงุน โ</button>
            </div>

            <h3 class="font-bold text-lg mb-4">ูุงุฆูุฉ ุงูุดุญู ุงูุณุฑูุน โก</h3>
            <div id="productList" class="grid grid-cols-2 gap-4">
                </div>
        </div>
    </div>

    <a href="https://wa.me/249XXXXXXXXX" class="fixed bottom-6 left-6 bg-green-500 text-white p-4 rounded-full shadow-2xl z-40">
        <i class="fab fa-whatsapp text-2xl"></i>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0jzecEwKgHpxHpTi8Y-_bwwfzVdtgf3E",
            authDomain: "khasmshop.firebaseapp.com",
            projectId: "khasmshop",
            storageBucket: "khasmshop.firebasestorage.app",
            messagingSenderId: "238182001615",
            appId: "1:238182001615:web:d77391030a40a481b440ba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ูุงุฆูุฉ ุงูุฅููููุงุช ุงูุฅุฏุงุฑูุฉ
        const admins = ["mohnadyasir43@gmail.com", "muhammedaltaj111@gmail.com", "mhmdfthu98@gmail.com"];

        let currentUserData = null;

        // ุงูููุชุฌุงุช ุงูุฃุณุงุณูุฉ
        const rawProducts = [
            { id: 1, name: "60 ุดุฏุฉ ุจุจุฌู", uc: 60, price: 4000 },
            { id: 2, name: "325 ุดุฏุฉ ุจุจุฌู", uc: 325, price: 18500 },
            { id: 3, name: "100 ุฌููุฑุฉ FF", uc: 100, price: 1200 },
        ];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (admins.includes(user.email.toLowerCase())) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }

                const walletRef = doc(db, "wallets", user.uid);
                const snap = await getDoc(walletRef);

                if (snap.exists()) {
                    currentUserData = snap.data();
                } else {
                    currentUserData = {
                        balance: 0,
                        totalUC: 0,
                        rank: "ุจุฑููุฒู",
                        walletID: Math.floor(100000 + Math.random() * 900000).toString(),
                        email: user.email
                    };
                    await setDoc(walletRef, currentUserData);
                }
                updateUI();
            } else {
                login();
            }
        });

        function updateUI() {
            const data = currentUserData;
            document.getElementById('balance').innerText = data.balance.toFixed(2);
            document.getElementById('sideWalletID').innerText = data.walletID;
            document.getElementById('totalUC').innerText = data.totalUC + " ุดุฏุฉ";
            
            // ุญุณุงุจ ุงูุฑุชุจุฉ ูุงูุฎุตู
            const rankInfo = getRankInfo(data.totalUC);
            document.getElementById('rankBadge').innerText = "ุฑุชุจุฉ: " + rankInfo.name;
            document.getElementById('rankBadge').className = `px-3 py-1 rounded-full text-[10px] font-bold ${rankInfo.color}`;
            
            // ุชุญุฏูุซ ุจุงุฑ ุงูุชูุฏู
            document.getElementById('nextRankText').innerText = `ุงูุฑุชุจุฉ ุงููุงุฏูุฉ: ${rankInfo.next}`;
            document.getElementById('progressText').innerText = `${data.totalUC}/${rankInfo.target}`;
            const percent = (data.totalUC / rankInfo.target) * 100;
            document.getElementById('progressBar').style.width = `${Math.min(percent, 100)}%`;

            renderProducts(rankInfo.discount);
        }

        function getRankInfo(uc) {
            if (uc >= 7400) return { name: "ูุงุณู", discount: 0.12, color: "bg-purple-100 text-purple-700", next: "ุงูููุฉ", target: 7400 };
            if (uc >= 4400) return { name: "ุจูุงุชููู", discount: 0.09, color: "bg-blue-100 text-blue-700", next: "ูุงุณู", target: 7400 };
            if (uc >= 2400) return { name: "ุฐูุจู", discount: 0.06, color: "bg-yellow-100 text-yellow-700", next: "ุจูุงุชููู", target: 4400 };
            if (uc >= 900) return { name: "ูุถู", discount: 0.03, color: "bg-gray-200 text-gray-700", next: "ุฐูุจู", target: 2400 };
            return { name: "ุจุฑููุฒู", discount: 0, color: "bg-orange-100 text-orange-700", next: "ูุถู", target: 900 };
        }

        function renderProducts(discount) {
            const list = document.getElementById('productList');
            list.innerHTML = "";
            rawProducts.forEach(p => {
                const finalPrice = p.price * (1 - discount);
                list.innerHTML += `
                    <div class="product-card bg-white p-4 rounded-3xl text-center">
                        <p class="text-xs font-bold mb-1">${p.name}</p>
                        <p class="text-blue-600 font-black text-lg">${finalPrice.toFixed(0)} <span class="text-[10px]">SDG</span></p>
                        ${discount > 0 ? `<p class="text-[9px] text-red-500 line-through">${p.price} SDG</p>` : ''}
                        <button onclick="handleBuy(${p.id}, ${finalPrice}, ${p.uc})" class="w-full bg-blue-900 text-white text-xs py-2 rounded-xl mt-3 font-bold">ุทูุจ ุดุญู</button>
                    </div>
                `;
            });
        }

        // ููุญุฉ ุงูุชุญูู - ุดุญู ุงููุญูุธุฉ
        window.confirmCharge = async () => {
            const id = document.getElementById('targetWalletID').value;
            const amount = parseFloat(document.getElementById('chargeAmount').value);

            if (id.length !== 6 || isNaN(amount)) return alert("ุชุฃูุฏ ูู ุฑูู ุงููุญูุธุฉ ูุงููุจูุบ!");

            if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุดุญู ${amount} SDG ูููุญูุธุฉ ุฑูู ${id}ุ`)) {
                const q = query(collection(db, "wallets"), where("walletID", "==", id));
                const snap = await getDocs(q);

                if (snap.empty) return alert("ุนุฐุฑุงูุ ุฑูู ุงููุญูุธุฉ ุบูุฑ ุตุญูุญ!");

                snap.forEach(async (docRef) => {
                    await updateDoc(doc(db, "wallets", docRef.id), {
                        balance: increment(amount)
                    });
                    alert("ุชูุช ุงูุนูููุฉ ุจูุฌุงุญ! ุชู ุฅูุฏุงุน ุงููุจูุบ.");
                    document.getElementById('chargeAmount').value = "";
                });
            }
        };

        // ุนูููุฉ ุงูุดุฑุงุก ูู ุงููุญูุธุฉ
        window.handleBuy = async (productId, price, ucAmount) => {
            if (currentUserData.balance < price) {
                return alert("ุนููุงู! ุฑุตูุฏู ุบูุฑ ูุงูู. ูุฑุฌู ุดุญู ูุญูุธุชู ูู ุงููููุงุก ุงููุนุชูุฏูู.");
            }

            if (confirm(`ูู ุชุฑูุฏ ุฅุชูุงู ุงูุทูุจ ุจุฎุตู ${price} SDG ูู ูุญูุธุชูุ`)) {
                const walletRef = doc(db, "wallets", auth.currentUser.uid);
                await updateDoc(walletRef, {
                    balance: increment(-price),
                    totalUC: increment(ucAmount)
                });
                alert("ุชู ุชูููุฐ ุทูุจู ุจูุฌุงุญ! ุณูุชู ุงูุดุญู ุฎูุงู ุฏูุงุฆู.");
                location.reload();
            }
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('translate-x-full');
        };

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
              </html>
